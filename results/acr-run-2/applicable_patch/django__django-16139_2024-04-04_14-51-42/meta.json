{
    "task_id": "django__django-16139",
    "setup_info": {
        "repo_path": "/home/haifeng/projects/reverse-prompt/SWE-bench/testbed/django__django/setup_django__django__4.2",
        "env_name": "setup_django__django__4.2",
        "pre_install": [],
        "install": "python -m pip install -e .",
        "test_cmd": "./tests/runtests.py --verbosity 2 auth_tests.test_forms"
    },
    "task_info": {
        "instance_id": "django__django-16139",
        "base_commit": "d559cb02da30f74debbb1fc3a46de0df134d2d80",
        "hints_text": "",
        "created_at": "2022-09-30T08:51:16Z",
        "test_patch": "diff --git a/tests/auth_tests/test_forms.py b/tests/auth_tests/test_forms.py\n--- a/tests/auth_tests/test_forms.py\n+++ b/tests/auth_tests/test_forms.py\n@@ -1,5 +1,6 @@\n import datetime\n import re\n+import urllib.parse\n from unittest import mock\n \n from django.contrib.auth.forms import (\n@@ -22,6 +23,7 @@\n from django.forms import forms\n from django.forms.fields import CharField, Field, IntegerField\n from django.test import SimpleTestCase, TestCase, override_settings\n+from django.urls import reverse\n from django.utils import translation\n from django.utils.text import capfirst\n from django.utils.translation import gettext as _\n@@ -892,6 +894,26 @@ def test_bug_19349_bound_password_field(self):\n         # value to render correctly\n         self.assertEqual(form.initial[\"password\"], form[\"password\"].value())\n \n+    @override_settings(ROOT_URLCONF=\"auth_tests.urls_admin\")\n+    def test_link_to_password_reset_in_helptext_via_to_field(self):\n+        user = User.objects.get(username=\"testclient\")\n+        form = UserChangeForm(data={}, instance=user)\n+        password_help_text = form.fields[\"password\"].help_text\n+        matches = re.search('<a href=\"(.*?)\">', password_help_text)\n+\n+        # URL to UserChangeForm in admin via to_field (instead of pk).\n+        admin_user_change_url = reverse(\n+            f\"admin:{user._meta.app_label}_{user._meta.model_name}_change\",\n+            args=(user.username,),\n+        )\n+        joined_url = urllib.parse.urljoin(admin_user_change_url, matches.group(1))\n+\n+        pw_change_url = reverse(\n+            f\"admin:{user._meta.app_label}_{user._meta.model_name}_password_change\",\n+            args=(user.pk,),\n+        )\n+        self.assertEqual(joined_url, pw_change_url)\n+\n     def test_custom_form(self):\n         class CustomUserChangeForm(UserChangeForm):\n             class Meta(UserChangeForm.Meta):\n",
        "repo": "django/django",
        "problem_statement": "Accessing UserAdmin via to_field leads to link to PasswordResetForm being broken (404)\nDescription\n\t \n\t\t(last modified by Simon Kern)\n\t \nAccessing the UserAdmin via another model's Admin that has a reference to User (with to_field set, e.g., to_field=\"uuid\") leads to the UserAdmin being accessed via an url that looks similar to this one:\n.../user/22222222-3333-4444-5555-666677778888/change/?_to_field=uuid\nHowever the underlying form looks like this: \nCode highlighting:\nclass UserChangeForm(forms.ModelForm):\n\tpassword = ReadOnlyPasswordHashField(\n\t\tlabel=_(\"Password\"),\n\t\thelp_text=_(\n\t\t\t\"Raw passwords are not stored, so there is no way to see this \"\n\t\t\t\"user\u2019s password, but you can change the password using \"\n\t\t\t'<a href=\"{}\">this form</a>.'\n\t\t),\n\t)\n\t...\n\t...\n\tdef __init__(self, *args, **kwargs):\n\t\tsuper().__init__(*args, **kwargs)\n\t\tpassword = self.fields.get(\"password\")\n\t\tif password:\n\t\t\tpassword.help_text = password.help_text.format(\"../password/\")\n\t...\n\t...\nThis results in the link to the PasswordResetForm being wrong and thus ending up in a 404. If we drop the assumption that UserAdmin is always accessed via its pk, then we're good to go. It's as simple as replacing password.help_text = password.help_text.format(\"../password/\") with password.help_text = password.help_text.format(f\"../../{self.instance.pk}/password/\")\nI've opened a pull request on GitHub for this Ticket, please see:\n\u200bPR\n",
        "version": "4.2",
        "FAIL_TO_PASS": [
            "test_link_to_password_reset_in_helptext_via_to_field (auth_tests.test_forms.UserChangeFormTest)"
        ],
        "PASS_TO_PASS": [
            "An invalid login doesn't leak the inactive status of a user.",
            "Inactive user cannot receive password reset email.",
            "Preserve the case of the user name (before the @ in the email address)",
            "ReadOnlyPasswordHashWidget doesn't contain a for attribute in the",
            "Test nonexistent email address. This should not fail because it would",
            "Test the PasswordResetForm.save() method with html_email_template_name",
            "Test the PasswordResetForm.save() method with no html_email_template_name",
            "The change form does not return the password value",
            "To prevent almost identical usernames, visually identical but differing",
            "UserCreationForm password validation uses all of the form's data.",
            "test_both_passwords (auth_tests.test_forms.UserCreationFormTest)",
            "test_bug_14242 (auth_tests.test_forms.UserChangeFormTest)",
            "test_bug_17944_empty_password (auth_tests.test_forms.UserChangeFormTest)",
            "test_bug_17944_unknown_password_algorithm (auth_tests.test_forms.UserChangeFormTest)",
            "test_bug_17944_unmanageable_password (auth_tests.test_forms.UserChangeFormTest)",
            "test_bug_19349_bound_password_field (auth_tests.test_forms.UserChangeFormTest)",
            "test_bug_19349_render_with_none_value (auth_tests.test_forms.ReadOnlyPasswordHashTest)",
            "test_cleaned_data (auth_tests.test_forms.PasswordResetFormTest)",
            "test_custom_email_constructor (auth_tests.test_forms.PasswordResetFormTest)",
            "test_custom_email_field (auth_tests.test_forms.PasswordResetFormTest)",
            "test_custom_email_subject (auth_tests.test_forms.PasswordResetFormTest)",
            "test_custom_form (auth_tests.test_forms.UserChangeFormTest)",
            "test_custom_form (auth_tests.test_forms.UserCreationFormTest)",
            "test_custom_form_hidden_username_field (auth_tests.test_forms.UserCreationFormTest)",
            "test_custom_form_with_different_username_field (auth_tests.test_forms.UserCreationFormTest)",
            "test_custom_login_allowed_policy (auth_tests.test_forms.AuthenticationFormTest)",
            "test_field_order (auth_tests.test_forms.PasswordChangeFormTest)",
            "test_get_invalid_login_error (auth_tests.test_forms.AuthenticationFormTest)",
            "test_help_text_translation (auth_tests.test_forms.SetPasswordFormTest)",
            "test_html_autocomplete_attributes (auth_tests.test_forms.AdminPasswordChangeFormTest)",
            "test_html_autocomplete_attributes (auth_tests.test_forms.AuthenticationFormTest)",
            "test_html_autocomplete_attributes (auth_tests.test_forms.PasswordChangeFormTest)",
            "test_html_autocomplete_attributes (auth_tests.test_forms.PasswordResetFormTest)",
            "test_html_autocomplete_attributes (auth_tests.test_forms.SetPasswordFormTest)",
            "test_html_autocomplete_attributes (auth_tests.test_forms.UserCreationFormTest)",
            "test_inactive_user (auth_tests.test_forms.AuthenticationFormTest)",
            "test_inactive_user_i18n (auth_tests.test_forms.AuthenticationFormTest)",
            "test_incorrect_password (auth_tests.test_forms.PasswordChangeFormTest)",
            "test_integer_username (auth_tests.test_forms.AuthenticationFormTest)",
            "test_invalid_data (auth_tests.test_forms.UserCreationFormTest)",
            "test_invalid_email (auth_tests.test_forms.PasswordResetFormTest)",
            "test_invalid_username (auth_tests.test_forms.AuthenticationFormTest)",
            "test_login_failed (auth_tests.test_forms.AuthenticationFormTest)",
            "test_missing_passwords (auth_tests.test_forms.AdminPasswordChangeFormTest)",
            "test_no_password (auth_tests.test_forms.AuthenticationFormTest)",
            "test_no_password (auth_tests.test_forms.SetPasswordFormTest)",
            "test_non_matching_passwords (auth_tests.test_forms.AdminPasswordChangeFormTest)",
            "test_normalize_username (auth_tests.test_forms.UserCreationFormTest)",
            "test_one_password (auth_tests.test_forms.AdminPasswordChangeFormTest)",
            "test_password_excluded (auth_tests.test_forms.UserChangeFormTest)",
            "test_password_help_text (auth_tests.test_forms.UserCreationFormTest)",
            "test_password_verification (auth_tests.test_forms.PasswordChangeFormTest)",
            "test_password_verification (auth_tests.test_forms.SetPasswordFormTest)",
            "test_password_verification (auth_tests.test_forms.UserCreationFormTest)",
            "test_password_whitespace_not_stripped (auth_tests.test_forms.AdminPasswordChangeFormTest)",
            "test_password_whitespace_not_stripped (auth_tests.test_forms.AuthenticationFormTest)",
            "test_password_whitespace_not_stripped (auth_tests.test_forms.PasswordChangeFormTest)",
            "test_password_whitespace_not_stripped (auth_tests.test_forms.SetPasswordFormTest)",
            "test_password_whitespace_not_stripped (auth_tests.test_forms.UserCreationFormTest)",
            "test_readonly_field_has_changed (auth_tests.test_forms.ReadOnlyPasswordHashTest)",
            "test_render (auth_tests.test_forms.ReadOnlyPasswordHashTest)",
            "test_success (auth_tests.test_forms.AdminPasswordChangeFormTest)",
            "test_success (auth_tests.test_forms.AuthenticationFormTest)",
            "test_success (auth_tests.test_forms.PasswordChangeFormTest)",
            "test_success (auth_tests.test_forms.SetPasswordFormTest)",
            "test_success (auth_tests.test_forms.UserCreationFormTest)",
            "test_unicode_username (auth_tests.test_forms.AuthenticationFormTest)",
            "test_unicode_username (auth_tests.test_forms.UserCreationFormTest)",
            "test_unusable_password (auth_tests.test_forms.PasswordResetFormTest)",
            "test_unusable_password (auth_tests.test_forms.UserChangeFormTest)",
            "test_user_already_exists (auth_tests.test_forms.UserCreationFormTest)",
            "test_user_email_domain_unicode_collision (auth_tests.test_forms.PasswordResetFormTest)",
            "test_user_email_domain_unicode_collision_nonexistent (auth_tests.test_forms.PasswordResetFormTest)",
            "test_user_email_unicode_collision (auth_tests.test_forms.PasswordResetFormTest)",
            "test_user_email_unicode_collision_nonexistent (auth_tests.test_forms.PasswordResetFormTest)",
            "test_username_field_autocapitalize_none (auth_tests.test_forms.AuthenticationFormTest)",
            "test_username_field_autocapitalize_none (auth_tests.test_forms.UserChangeFormTest)",
            "test_username_field_autocapitalize_none (auth_tests.test_forms.UserCreationFormTest)",
            "test_username_field_label (auth_tests.test_forms.AuthenticationFormTest)",
            "test_username_field_label_empty_string (auth_tests.test_forms.AuthenticationFormTest)",
            "test_username_field_label_not_set (auth_tests.test_forms.AuthenticationFormTest)",
            "test_username_field_max_length_defaults_to_254 (auth_tests.test_forms.AuthenticationFormTest)",
            "test_username_field_max_length_matches_user_model (auth_tests.test_forms.AuthenticationFormTest)",
            "test_username_validity (auth_tests.test_forms.UserChangeFormTest)",
            "test_validates_password (auth_tests.test_forms.SetPasswordFormTest)",
            "test_validates_password (auth_tests.test_forms.UserCreationFormTest)"
        ],
        "environment_setup_commit": "0fbdb9784da915fce5dcc1fe82bac9b4785749e5",
        "patch": "diff --git a/django/contrib/auth/forms.py b/django/contrib/auth/forms.py\n--- a/django/contrib/auth/forms.py\n+++ b/django/contrib/auth/forms.py\n@@ -163,7 +163,9 @@ def __init__(self, *args, **kwargs):\n         super().__init__(*args, **kwargs)\n         password = self.fields.get(\"password\")\n         if password:\n-            password.help_text = password.help_text.format(\"../password/\")\n+            password.help_text = password.help_text.format(\n+                f\"../../{self.instance.pk}/password/\"\n+            )\n         user_permissions = self.fields.get(\"user_permissions\")\n         if user_permissions:\n             user_permissions.queryset = user_permissions.queryset.select_related(\n",
        "pr_link": "https://github.com/django/django/pull/16139"
    }
}