{
    "task_id": "django__django-15996",
    "setup_info": {
        "repo_path": "/home/haifeng/projects/reverse-prompt/SWE-bench/testbed/django__django/setup_django__django__4.2",
        "env_name": "setup_django__django__4.2",
        "pre_install": [],
        "install": "python -m pip install -e .",
        "test_cmd": "./tests/runtests.py --verbosity 2 migrations.test_writer"
    },
    "task_info": {
        "instance_id": "django__django-15996",
        "base_commit": "b30c0081d4d8a31ab7dc7f72a4c7099af606ef29",
        "hints_text": "patch of the EnumSerializer",
        "created_at": "2022-08-25T04:49:14Z",
        "test_patch": "diff --git a/tests/migrations/test_writer.py b/tests/migrations/test_writer.py\n--- a/tests/migrations/test_writer.py\n+++ b/tests/migrations/test_writer.py\n@@ -413,6 +413,14 @@ def test_serialize_enum_flags(self):\n             \"(2, migrations.test_writer.IntFlagEnum['B'])], \"\n             \"default=migrations.test_writer.IntFlagEnum['A'])\",\n         )\n+        self.assertSerializedResultEqual(\n+            IntFlagEnum.A | IntFlagEnum.B,\n+            (\n+                \"migrations.test_writer.IntFlagEnum['A'] | \"\n+                \"migrations.test_writer.IntFlagEnum['B']\",\n+                {\"import migrations.test_writer\"},\n+            ),\n+        )\n \n     def test_serialize_choices(self):\n         class TextChoices(models.TextChoices):\n",
        "repo": "django/django",
        "problem_statement": "Support for serialization of combination of Enum flags.\nDescription\n\t \n\t\t(last modified by Willem Van Onsem)\n\t \nIf we work with a field:\nregex_flags = models.IntegerField(default=re.UNICODE | re.IGNORECASE)\nThis is turned into a migration with:\ndefault=re.RegexFlag[None]\nThis is due to the fact that the EnumSerializer aims to work with the .name of the item, but if there is no single item for the given value, then there is no such name.\nIn that case, we can use enum._decompose to obtain a list of names, and create an expression to create the enum value by \"ORing\" the items together.\n",
        "version": "4.2",
        "FAIL_TO_PASS": [
            "test_serialize_enum_flags (migrations.test_writer.WriterTests)"
        ],
        "PASS_TO_PASS": [
            "#24155 - Tests ordering of imports.",
            "A reference in a local scope can't be serialized.",
            "An unbound method used within a class body can be serialized.",
            "Make sure compiled regex can be serialized.",
            "Test comments at top of file.",
            "Tests serializing a simple migration.",
            "Ticket #22679: makemigrations generates invalid code for (an empty",
            "Ticket #22943: Test serialization of class-based validators, including",
            "django.db.models shouldn't be imported if unused.",
            "test_args_kwargs_signature (migrations.test_writer.OperationWriterTests)",
            "test_args_signature (migrations.test_writer.OperationWriterTests)",
            "test_custom_operation (migrations.test_writer.WriterTests)",
            "test_deconstruct_class_arguments (migrations.test_writer.WriterTests)",
            "test_empty_signature (migrations.test_writer.OperationWriterTests)",
            "test_expand_args_signature (migrations.test_writer.OperationWriterTests)",
            "test_kwargs_signature (migrations.test_writer.OperationWriterTests)",
            "test_migration_path (migrations.test_writer.WriterTests)",
            "test_multiline_args_signature (migrations.test_writer.OperationWriterTests)",
            "test_nested_args_signature (migrations.test_writer.OperationWriterTests)",
            "test_nested_operation_expand_args_signature (migrations.test_writer.OperationWriterTests)",
            "test_register_non_serializer (migrations.test_writer.WriterTests)",
            "test_register_serializer (migrations.test_writer.WriterTests)",
            "test_serialize_builtin_types (migrations.test_writer.WriterTests)",
            "test_serialize_builtins (migrations.test_writer.WriterTests)",
            "test_serialize_choices (migrations.test_writer.WriterTests)",
            "test_serialize_collections (migrations.test_writer.WriterTests)",
            "test_serialize_complex_func_index (migrations.test_writer.WriterTests)",
            "test_serialize_constants (migrations.test_writer.WriterTests)",
            "test_serialize_datetime (migrations.test_writer.WriterTests)",
            "test_serialize_enums (migrations.test_writer.WriterTests)",
            "test_serialize_fields (migrations.test_writer.WriterTests)",
            "test_serialize_frozensets (migrations.test_writer.WriterTests)",
            "test_serialize_functions (migrations.test_writer.WriterTests)",
            "test_serialize_functools_partial (migrations.test_writer.WriterTests)",
            "test_serialize_functools_partialmethod (migrations.test_writer.WriterTests)",
            "test_serialize_iterators (migrations.test_writer.WriterTests)",
            "test_serialize_lazy_objects (migrations.test_writer.WriterTests)",
            "test_serialize_managers (migrations.test_writer.WriterTests)",
            "test_serialize_multiline_strings (migrations.test_writer.WriterTests)",
            "test_serialize_nested_class (migrations.test_writer.WriterTests)",
            "test_serialize_numbers (migrations.test_writer.WriterTests)",
            "test_serialize_path_like (migrations.test_writer.WriterTests)",
            "test_serialize_pathlib (migrations.test_writer.WriterTests)",
            "test_serialize_range (migrations.test_writer.WriterTests)",
            "test_serialize_set (migrations.test_writer.WriterTests)",
            "test_serialize_settings (migrations.test_writer.WriterTests)",
            "test_serialize_strings (migrations.test_writer.WriterTests)",
            "test_serialize_timedelta (migrations.test_writer.WriterTests)",
            "test_serialize_type_model (migrations.test_writer.WriterTests)",
            "test_serialize_type_none (migrations.test_writer.WriterTests)",
            "test_serialize_uuid (migrations.test_writer.WriterTests)"
        ],
        "environment_setup_commit": "0fbdb9784da915fce5dcc1fe82bac9b4785749e5",
        "patch": "diff --git a/django/db/migrations/serializer.py b/django/db/migrations/serializer.py\n--- a/django/db/migrations/serializer.py\n+++ b/django/db/migrations/serializer.py\n@@ -16,7 +16,7 @@\n from django.db.migrations.operations.base import Operation\n from django.db.migrations.utils import COMPILED_REGEX_TYPE, RegexObject\n from django.utils.functional import LazyObject, Promise\n-from django.utils.version import get_docs_version\n+from django.utils.version import PY311, get_docs_version\n \n \n class BaseSerializer:\n@@ -125,8 +125,21 @@ class EnumSerializer(BaseSerializer):\n     def serialize(self):\n         enum_class = self.value.__class__\n         module = enum_class.__module__\n+        if issubclass(enum_class, enum.Flag):\n+            if PY311:\n+                members = list(self.value)\n+            else:\n+                members, _ = enum._decompose(enum_class, self.value)\n+                members = reversed(members)\n+        else:\n+            members = (self.value,)\n         return (\n-            \"%s.%s[%r]\" % (module, enum_class.__qualname__, self.value.name),\n+            \" | \".join(\n+                [\n+                    f\"{module}.{enum_class.__qualname__}[{item.name!r}]\"\n+                    for item in members\n+                ]\n+            ),\n             {\"import %s\" % module},\n         )\n \n",
        "pr_link": "https://github.com/django/django/pull/15996"
    }
}