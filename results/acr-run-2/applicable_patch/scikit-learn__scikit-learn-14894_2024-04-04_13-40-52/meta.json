{
    "task_id": "scikit-learn__scikit-learn-14894",
    "setup_info": {
        "repo_path": "/home/haifeng/projects/reverse-prompt/SWE-bench/testbed/scikit-learn__scikit-learn/setup_scikit-learn__scikit-learn__0.22",
        "env_name": "setup_scikit-learn__scikit-learn__0.22",
        "pre_install": [],
        "install": "python -m pip install -v --no-use-pep517 --no-build-isolation -e .",
        "test_cmd": "pytest --no-header -rA --tb=no -p no:cacheprovider sklearn/svm/tests/test_svm.py"
    },
    "task_info": {
        "instance_id": "scikit-learn__scikit-learn-14894",
        "base_commit": "fdbaa58acbead5a254f2e6d597dc1ab3b947f4c6",
        "hints_text": "",
        "created_at": "2019-09-05T17:41:11Z",
        "test_patch": "diff --git a/sklearn/svm/tests/test_svm.py b/sklearn/svm/tests/test_svm.py\n--- a/sklearn/svm/tests/test_svm.py\n+++ b/sklearn/svm/tests/test_svm.py\n@@ -690,6 +690,19 @@ def test_sparse_precomputed():\n         assert \"Sparse precomputed\" in str(e)\n \n \n+def test_sparse_fit_support_vectors_empty():\n+    # Regression test for #14893\n+    X_train = sparse.csr_matrix([[0, 1, 0, 0],\n+                                 [0, 0, 0, 1],\n+                                 [0, 0, 1, 0],\n+                                 [0, 0, 0, 1]])\n+    y_train = np.array([0.04, 0.04, 0.10, 0.16])\n+    model = svm.SVR(kernel='linear')\n+    model.fit(X_train, y_train)\n+    assert not model.support_vectors_.data.size\n+    assert not model.dual_coef_.data.size\n+\n+\n def test_linearsvc_parameters():\n     # Test possible parameter combinations in LinearSVC\n     # Generate list of possible parameter combinations\n",
        "repo": "scikit-learn/scikit-learn",
        "problem_statement": "ZeroDivisionError in _sparse_fit for SVM with empty support_vectors_\n#### Description\r\nWhen using sparse data, in the case where the support_vectors_ attribute is be empty, _fit_sparse gives a ZeroDivisionError\r\n\r\n#### Steps/Code to Reproduce\r\n```\r\nimport numpy as np\r\nimport scipy\r\nimport sklearn\r\nfrom sklearn.svm import SVR\r\nx_train = np.array([[0, 1, 0, 0],\r\n[0, 0, 0, 1],\r\n[0, 0, 1, 0],\r\n[0, 0, 0, 1]])\r\ny_train = np.array([0.04, 0.04, 0.10, 0.16])\r\nmodel = SVR(C=316.227766017, cache_size=200, coef0=0.0, degree=3, epsilon=0.1,\r\n  \t    gamma=1.0, kernel='linear', max_iter=15000,\r\n  \t    shrinking=True, tol=0.001, verbose=False)\r\n# dense x_train has no error\r\nmodel.fit(x_train, y_train)\r\n\r\n# convert to sparse\r\nxtrain= scipy.sparse.csr_matrix(x_train)\r\nmodel.fit(xtrain, y_train)\r\n\r\n```\r\n#### Expected Results\r\nNo error is thrown and  `self.dual_coef_ = sp.csr_matrix([])`\r\n\r\n#### Actual Results\r\n```\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/usr/local/lib/python3.5/dist-packages/sklearn/svm/base.py\", line 209, in fit\r\n    fit(X, y, sample_weight, solver_type, kernel, random_seed=seed)\r\n  File \"/usr/local/lib/python3.5/dist-packages/sklearn/svm/base.py\", line 302, in _sparse_fit\r\n    dual_coef_indices.size / n_class)\r\nZeroDivisionError: float division by zero\r\n```\r\n\r\n#### Versions\r\n```\r\n>>> sklearn.show_versions() \r\n\r\nSystem:\r\nexecutable: /usr/bin/python3\r\n    python: 3.5.2 (default, Nov 12 2018, 13:43:14)  [GCC 5.4.0 20160609]\r\n   machine: Linux-4.15.0-58-generic-x86_64-with-Ubuntu-16.04-xenial\r\n\r\nPython deps:\r\n     numpy: 1.17.0\r\n    Cython: None\r\n       pip: 19.2.1\r\n    pandas: 0.22.0\r\n   sklearn: 0.21.3\r\n     scipy: 1.3.0\r\nsetuptools: 40.4.3\r\n```\n",
        "version": "0.22",
        "FAIL_TO_PASS": [
            "sklearn/svm/tests/test_svm.py::test_sparse_fit_support_vectors_empty"
        ],
        "PASS_TO_PASS": [
            "sklearn/svm/tests/test_svm.py::test_auto_weight",
            "sklearn/svm/tests/test_svm.py::test_bad_input",
            "sklearn/svm/tests/test_svm.py::test_consistent_proba",
            "sklearn/svm/tests/test_svm.py::test_crammer_singer_binary",
            "sklearn/svm/tests/test_svm.py::test_decision_function",
            "sklearn/svm/tests/test_svm.py::test_decision_function_shape",
            "sklearn/svm/tests/test_svm.py::test_decision_function_shape_two_class",
            "sklearn/svm/tests/test_svm.py::test_dense_liblinear_intercept_handling",
            "sklearn/svm/tests/test_svm.py::test_gamma_auto",
            "sklearn/svm/tests/test_svm.py::test_gamma_scale",
            "sklearn/svm/tests/test_svm.py::test_hasattr_predict_proba",
            "sklearn/svm/tests/test_svm.py::test_immutable_coef_property",
            "sklearn/svm/tests/test_svm.py::test_liblinear_set_coef",
            "sklearn/svm/tests/test_svm.py::test_libsvm_iris",
            "sklearn/svm/tests/test_svm.py::test_libsvm_parameters",
            "sklearn/svm/tests/test_svm.py::test_linear_svc_intercept_scaling",
            "sklearn/svm/tests/test_svm.py::test_linear_svm_convergence_warnings",
            "sklearn/svm/tests/test_svm.py::test_linear_svx_uppercase_loss_penality_raises_error",
            "sklearn/svm/tests/test_svm.py::test_linearsvc",
            "sklearn/svm/tests/test_svm.py::test_linearsvc_crammer_singer",
            "sklearn/svm/tests/test_svm.py::test_linearsvc_fit_sampleweight",
            "sklearn/svm/tests/test_svm.py::test_linearsvc_iris",
            "sklearn/svm/tests/test_svm.py::test_linearsvc_parameters",
            "sklearn/svm/tests/test_svm.py::test_linearsvc_verbose",
            "sklearn/svm/tests/test_svm.py::test_linearsvr",
            "sklearn/svm/tests/test_svm.py::test_linearsvr_fit_sampleweight",
            "sklearn/svm/tests/test_svm.py::test_linearsvx_loss_penalty_deprecations",
            "sklearn/svm/tests/test_svm.py::test_lsvc_intercept_scaling_zero",
            "sklearn/svm/tests/test_svm.py::test_n_support_oneclass_svr",
            "sklearn/svm/tests/test_svm.py::test_negative_sample_weights_mask_all_samples[weights-are-negative-NuSVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_sample_weights_mask_all_samples[weights-are-negative-NuSVR]",
            "sklearn/svm/tests/test_svm.py::test_negative_sample_weights_mask_all_samples[weights-are-negative-OneClassSVM]",
            "sklearn/svm/tests/test_svm.py::test_negative_sample_weights_mask_all_samples[weights-are-negative-SVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_sample_weights_mask_all_samples[weights-are-negative-SVR]",
            "sklearn/svm/tests/test_svm.py::test_negative_sample_weights_mask_all_samples[weights-are-zero-NuSVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_sample_weights_mask_all_samples[weights-are-zero-NuSVR]",
            "sklearn/svm/tests/test_svm.py::test_negative_sample_weights_mask_all_samples[weights-are-zero-OneClassSVM]",
            "sklearn/svm/tests/test_svm.py::test_negative_sample_weights_mask_all_samples[weights-are-zero-SVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_sample_weights_mask_all_samples[weights-are-zero-SVR]",
            "sklearn/svm/tests/test_svm.py::test_negative_weight_equal_coeffs[partial-mask-label-1-NuSVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_weight_equal_coeffs[partial-mask-label-1-NuSVR]",
            "sklearn/svm/tests/test_svm.py::test_negative_weight_equal_coeffs[partial-mask-label-1-SVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_weight_equal_coeffs[partial-mask-label-2-NuSVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_weight_equal_coeffs[partial-mask-label-2-NuSVR]",
            "sklearn/svm/tests/test_svm.py::test_negative_weight_equal_coeffs[partial-mask-label-2-SVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_weights_svc_leave_just_one_label[mask-label-1-NuSVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_weights_svc_leave_just_one_label[mask-label-1-SVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_weights_svc_leave_just_one_label[mask-label-2-NuSVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_weights_svc_leave_just_one_label[mask-label-2-SVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_weights_svc_leave_two_labels[partial-mask-label-1-NuSVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_weights_svc_leave_two_labels[partial-mask-label-1-SVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_weights_svc_leave_two_labels[partial-mask-label-2-NuSVC]",
            "sklearn/svm/tests/test_svm.py::test_negative_weights_svc_leave_two_labels[partial-mask-label-2-SVC]",
            "sklearn/svm/tests/test_svm.py::test_oneclass",
            "sklearn/svm/tests/test_svm.py::test_oneclass_decision_function",
            "sklearn/svm/tests/test_svm.py::test_oneclass_score_samples",
            "sklearn/svm/tests/test_svm.py::test_ovr_decision_function",
            "sklearn/svm/tests/test_svm.py::test_precomputed",
            "sklearn/svm/tests/test_svm.py::test_probability",
            "sklearn/svm/tests/test_svm.py::test_sparse_precomputed",
            "sklearn/svm/tests/test_svm.py::test_svc_bad_kernel",
            "sklearn/svm/tests/test_svm.py::test_svc_clone_with_callable_kernel",
            "sklearn/svm/tests/test_svm.py::test_svc_invalid_break_ties_param[NuSVC]",
            "sklearn/svm/tests/test_svm.py::test_svc_invalid_break_ties_param[SVC]",
            "sklearn/svm/tests/test_svm.py::test_svc_ovr_tie_breaking[NuSVC]",
            "sklearn/svm/tests/test_svm.py::test_svc_ovr_tie_breaking[SVC]",
            "sklearn/svm/tests/test_svm.py::test_svm_classifier_sided_sample_weight[estimator0]",
            "sklearn/svm/tests/test_svm.py::test_svm_classifier_sided_sample_weight[estimator1]",
            "sklearn/svm/tests/test_svm.py::test_svm_equivalence_sample_weight_C",
            "sklearn/svm/tests/test_svm.py::test_svm_gamma_error[NuSVC-data1]",
            "sklearn/svm/tests/test_svm.py::test_svm_gamma_error[NuSVR-data3]",
            "sklearn/svm/tests/test_svm.py::test_svm_gamma_error[OneClassSVM-data4]",
            "sklearn/svm/tests/test_svm.py::test_svm_gamma_error[SVC-data0]",
            "sklearn/svm/tests/test_svm.py::test_svm_gamma_error[SVR-data2]",
            "sklearn/svm/tests/test_svm.py::test_svm_regressor_sided_sample_weight[estimator0]",
            "sklearn/svm/tests/test_svm.py::test_svm_regressor_sided_sample_weight[estimator1]",
            "sklearn/svm/tests/test_svm.py::test_svr",
            "sklearn/svm/tests/test_svm.py::test_svr_coef_sign",
            "sklearn/svm/tests/test_svm.py::test_svr_errors",
            "sklearn/svm/tests/test_svm.py::test_svr_predict",
            "sklearn/svm/tests/test_svm.py::test_timeout",
            "sklearn/svm/tests/test_svm.py::test_tweak_params",
            "sklearn/svm/tests/test_svm.py::test_unfitted",
            "sklearn/svm/tests/test_svm.py::test_unicode_kernel",
            "sklearn/svm/tests/test_svm.py::test_weight"
        ],
        "environment_setup_commit": "7e85a6d1f038bbb932b36f18d75df6be937ed00d",
        "patch": "diff --git a/sklearn/svm/base.py b/sklearn/svm/base.py\n--- a/sklearn/svm/base.py\n+++ b/sklearn/svm/base.py\n@@ -287,11 +287,14 @@ def _sparse_fit(self, X, y, sample_weight, solver_type, kernel,\n         n_SV = self.support_vectors_.shape[0]\n \n         dual_coef_indices = np.tile(np.arange(n_SV), n_class)\n-        dual_coef_indptr = np.arange(0, dual_coef_indices.size + 1,\n-                                     dual_coef_indices.size / n_class)\n-        self.dual_coef_ = sp.csr_matrix(\n-            (dual_coef_data, dual_coef_indices, dual_coef_indptr),\n-            (n_class, n_SV))\n+        if not n_SV:\n+            self.dual_coef_ = sp.csr_matrix([])\n+        else:\n+            dual_coef_indptr = np.arange(0, dual_coef_indices.size + 1,\n+                                         dual_coef_indices.size / n_class)\n+            self.dual_coef_ = sp.csr_matrix(\n+                (dual_coef_data, dual_coef_indices, dual_coef_indptr),\n+                (n_class, n_SV))\n \n     def predict(self, X):\n         \"\"\"Perform regression on samples in X.\n",
        "pr_link": "https://github.com/scikit-learn/scikit-learn/pull/14894"
    }
}