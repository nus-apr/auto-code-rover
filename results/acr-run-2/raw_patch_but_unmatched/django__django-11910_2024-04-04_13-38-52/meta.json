{
    "task_id": "django__django-11910",
    "setup_info": {
        "repo_path": "/home/haifeng/projects/reverse-prompt/SWE-bench/testbed/django__django/setup_django__django__3.1",
        "env_name": "setup_django__django__3.1",
        "pre_install": [],
        "install": "python -m pip install -e .",
        "test_cmd": "./tests/runtests.py --verbosity 2 migrations.test_autodetector"
    },
    "task_info": {
        "instance_id": "django__django-11910",
        "base_commit": "d232fd76a85870daf345fd8f8d617fe7802ae194",
        "hints_text": "Thanks for this ticket. It looks like a regression in dcdd219ee1e062dc6189f382e0298e0adf5d5ddf, because an AlterField operation wasn't generated in such cases before this change (and I don't think we need it).",
        "created_at": "2019-10-14T01:56:49Z",
        "test_patch": "diff --git a/tests/migrations/test_autodetector.py b/tests/migrations/test_autodetector.py\n--- a/tests/migrations/test_autodetector.py\n+++ b/tests/migrations/test_autodetector.py\n@@ -932,6 +932,30 @@ def test_rename_foreign_object_fields(self):\n             changes, 'app', 0, 1, model_name='bar', old_name='second', new_name='second_renamed',\n         )\n \n+    def test_rename_referenced_primary_key(self):\n+        before = [\n+            ModelState('app', 'Foo', [\n+                ('id', models.CharField(primary_key=True, serialize=False)),\n+            ]),\n+            ModelState('app', 'Bar', [\n+                ('id', models.AutoField(primary_key=True)),\n+                ('foo', models.ForeignKey('app.Foo', models.CASCADE)),\n+            ]),\n+        ]\n+        after = [\n+            ModelState('app', 'Foo', [\n+                ('renamed_id', models.CharField(primary_key=True, serialize=False))\n+            ]),\n+            ModelState('app', 'Bar', [\n+                ('id', models.AutoField(primary_key=True)),\n+                ('foo', models.ForeignKey('app.Foo', models.CASCADE)),\n+            ]),\n+        ]\n+        changes = self.get_changes(before, after, MigrationQuestioner({'ask_rename': True}))\n+        self.assertNumberMigrations(changes, 'app', 1)\n+        self.assertOperationTypes(changes, 'app', 0, ['RenameField'])\n+        self.assertOperationAttributes(changes, 'app', 0, 0, old_name='id', new_name='renamed_id')\n+\n     def test_rename_field_preserved_db_column(self):\n         \"\"\"\n         RenameField is used if a field is renamed and db_column equal to the\n",
        "repo": "django/django",
        "problem_statement": "ForeignKey's to_field parameter gets the old field's name when renaming a PrimaryKey.\nDescription\n\t\nHaving these two models \nclass ModelA(models.Model):\n\tfield_wrong = models.CharField('field1', max_length=50, primary_key=True) # I'm a Primary key.\nclass ModelB(models.Model):\n\tfield_fk = models.ForeignKey(ModelA, blank=True, null=True, on_delete=models.CASCADE) \n... migrations applyed ...\nthe ModelA.field_wrong field has been renamed ... and Django recognizes the \"renaming\"\n# Primary key renamed\nclass ModelA(models.Model):\n\tfield_fixed = models.CharField('field1', max_length=50, primary_key=True) # I'm a Primary key.\nAttempts to to_field parameter. \nThe to_field points to the old_name (field_typo) and not to the new one (\"field_fixed\")\nclass Migration(migrations.Migration):\n\tdependencies = [\n\t\t('app1', '0001_initial'),\n\t]\n\toperations = [\n\t\tmigrations.RenameField(\n\t\t\tmodel_name='modela',\n\t\t\told_name='field_wrong',\n\t\t\tnew_name='field_fixed',\n\t\t),\n\t\tmigrations.AlterField(\n\t\t\tmodel_name='modelb',\n\t\t\tname='modela',\n\t\t\tfield=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='app1.ModelB', to_field='field_wrong'),\n\t\t),\n\t]\n",
        "version": "3.1",
        "FAIL_TO_PASS": [
            "test_rename_referenced_primary_key (migrations.test_autodetector.AutodetectorTests)"
        ],
        "PASS_TO_PASS": [
            "#22030 - Adding a field with a default should work.",
            "#22435 - Adding a ManyToManyField should not prompt for a default.",
            "#23956 - Inheriting models doesn't move *_ptr fields into AddField operations.",
            "Bases of other models come first.",
            "Bases of proxies come first.",
            "Changing a model's options should make a change.",
            "Changing a proxy model's options should also make a change.",
            "FK dependencies still work on proxy models.",
            "Field instances are handled correctly by nested deconstruction.",
            "Having a ForeignKey automatically adds a dependency.",
            "Nested deconstruction descends into dict values.",
            "Nested deconstruction descends into lists.",
            "Nested deconstruction descends into tuples.",
            "Setting order_with_respect_to adds a field.",
            "Swappable models get their CreateModel first.",
            "Test change detection of new constraints.",
            "Test change detection of new indexes.",
            "Test change detection of removed constraints.",
            "Test change detection of removed indexes.",
            "Test change detection of reordering of fields in indexes.",
            "Test creation of new model with constraints already defined.",
            "Test creation of new model with indexes already defined.",
            "Tests auto-naming of migrations for graph matching.",
            "Tests autodetection of new fields.",
            "Tests autodetection of new models.",
            "Tests autodetection of removed fields.",
            "Tests autodetection of renamed fields.",
            "Tests autodetection of renamed models.",
            "Tests custom naming of migrations for graph matching.",
            "Tests deletion of old models.",
            "Tests detection for adding db_table in model's options.",
            "Tests detection for changing db_table in model's options'.",
            "Tests detection for removing db_table in model's options.",
            "Tests index/unique_together detection.",
            "Tests unique_together and field removal detection & ordering",
            "The autodetector correctly deals with managed models.",
            "The autodetector correctly deals with proxy models.",
            "test_add_alter_order_with_respect_to (migrations.test_autodetector.AutodetectorTests)",
            "test_add_blank_textfield_and_charfield (migrations.test_autodetector.AutodetectorTests)",
            "test_add_date_fields_with_auto_now_add_asking_for_default (migrations.test_autodetector.AutodetectorTests)",
            "test_add_date_fields_with_auto_now_add_not_asking_for_null_addition (migrations.test_autodetector.AutodetectorTests)",
            "test_add_date_fields_with_auto_now_not_asking_for_default (migrations.test_autodetector.AutodetectorTests)",
            "test_add_field_and_foo_together (migrations.test_autodetector.AutodetectorTests)",
            "test_add_model_order_with_respect_to (migrations.test_autodetector.AutodetectorTests)",
            "test_add_non_blank_textfield_and_charfield (migrations.test_autodetector.AutodetectorTests)",
            "test_alter_db_table_no_changes (migrations.test_autodetector.AutodetectorTests)",
            "test_alter_db_table_with_model_change (migrations.test_autodetector.AutodetectorTests)",
            "test_alter_field_to_fk_dependency_other_app (migrations.test_autodetector.AutodetectorTests)",
            "test_alter_field_to_not_null_oneoff_default (migrations.test_autodetector.AutodetectorTests)",
            "test_alter_field_to_not_null_with_default (migrations.test_autodetector.AutodetectorTests)",
            "test_alter_field_to_not_null_without_default (migrations.test_autodetector.AutodetectorTests)",
            "test_alter_fk_before_model_deletion (migrations.test_autodetector.AutodetectorTests)",
            "test_alter_many_to_many (migrations.test_autodetector.AutodetectorTests)",
            "test_alter_model_managers (migrations.test_autodetector.AutodetectorTests)",
            "test_circular_dependency_mixed_addcreate (migrations.test_autodetector.AutodetectorTests)",
            "test_circular_dependency_swappable (migrations.test_autodetector.AutodetectorTests)",
            "test_circular_dependency_swappable2 (migrations.test_autodetector.AutodetectorTests)",
            "test_circular_dependency_swappable_self (migrations.test_autodetector.AutodetectorTests)",
            "test_circular_fk_dependency (migrations.test_autodetector.AutodetectorTests)",
            "test_concrete_field_changed_to_many_to_many (migrations.test_autodetector.AutodetectorTests)",
            "test_create_model_and_unique_together (migrations.test_autodetector.AutodetectorTests)",
            "test_create_with_through_model (migrations.test_autodetector.AutodetectorTests)",
            "test_custom_deconstructible (migrations.test_autodetector.AutodetectorTests)",
            "test_deconstruct_type (migrations.test_autodetector.AutodetectorTests)",
            "test_default_related_name_option (migrations.test_autodetector.AutodetectorTests)",
            "test_different_regex_does_alter (migrations.test_autodetector.AutodetectorTests)",
            "test_empty_foo_together (migrations.test_autodetector.AutodetectorTests)",
            "test_first_dependency (migrations.test_autodetector.AutodetectorTests)",
            "test_fk_dependency_other_app (migrations.test_autodetector.AutodetectorTests)",
            "test_foo_together_no_changes (migrations.test_autodetector.AutodetectorTests)",
            "test_foo_together_ordering (migrations.test_autodetector.AutodetectorTests)",
            "test_foreign_key_removed_before_target_model (migrations.test_autodetector.AutodetectorTests)",
            "test_identical_regex_doesnt_alter (migrations.test_autodetector.AutodetectorTests)",
            "test_keep_db_table_with_model_change (migrations.test_autodetector.AutodetectorTests)",
            "test_last_dependency (migrations.test_autodetector.AutodetectorTests)",
            "test_m2m_w_through_multistep_remove (migrations.test_autodetector.AutodetectorTests)",
            "test_managed_to_unmanaged (migrations.test_autodetector.AutodetectorTests)",
            "test_many_to_many_changed_to_concrete_field (migrations.test_autodetector.AutodetectorTests)",
            "test_many_to_many_removed_before_through_model (migrations.test_autodetector.AutodetectorTests)",
            "test_many_to_many_removed_before_through_model_2 (migrations.test_autodetector.AutodetectorTests)",
            "test_mti_inheritance_model_removal (migrations.test_autodetector.AutodetectorTests)",
            "test_nested_deconstructible_objects (migrations.test_autodetector.AutodetectorTests)",
            "test_non_circular_foreignkey_dependency_removal (migrations.test_autodetector.AutodetectorTests)",
            "test_pk_fk_included (migrations.test_autodetector.AutodetectorTests)",
            "test_proxy_custom_pk (migrations.test_autodetector.AutodetectorTests)",
            "test_proxy_to_mti_with_fk_to_proxy (migrations.test_autodetector.AutodetectorTests)",
            "test_proxy_to_mti_with_fk_to_proxy_proxy (migrations.test_autodetector.AutodetectorTests)",
            "test_remove_alter_order_with_respect_to (migrations.test_autodetector.AutodetectorTests)",
            "test_remove_field_and_foo_together (migrations.test_autodetector.AutodetectorTests)",
            "test_rename_field_and_foo_together (migrations.test_autodetector.AutodetectorTests)",
            "test_rename_field_foreign_key_to_field (migrations.test_autodetector.AutodetectorTests)",
            "test_rename_field_preserved_db_column (migrations.test_autodetector.AutodetectorTests)",
            "test_rename_foreign_object_fields (migrations.test_autodetector.AutodetectorTests)",
            "test_rename_m2m_through_model (migrations.test_autodetector.AutodetectorTests)",
            "test_rename_model_reverse_relation_dependencies (migrations.test_autodetector.AutodetectorTests)",
            "test_rename_model_with_fks_in_different_position (migrations.test_autodetector.AutodetectorTests)",
            "test_rename_model_with_renamed_rel_field (migrations.test_autodetector.AutodetectorTests)",
            "test_rename_related_field_preserved_db_column (migrations.test_autodetector.AutodetectorTests)",
            "test_replace_string_with_foreignkey (migrations.test_autodetector.AutodetectorTests)",
            "test_same_app_circular_fk_dependency (migrations.test_autodetector.AutodetectorTests)",
            "test_same_app_circular_fk_dependency_with_unique_together_and_indexes (migrations.test_autodetector.AutodetectorTests)",
            "test_same_app_no_fk_dependency (migrations.test_autodetector.AutodetectorTests)",
            "test_supports_functools_partial (migrations.test_autodetector.AutodetectorTests)",
            "test_swappable (migrations.test_autodetector.AutodetectorTests)",
            "test_swappable_changed (migrations.test_autodetector.AutodetectorTests)",
            "test_swappable_circular_multi_mti (migrations.test_autodetector.AutodetectorTests)",
            "test_trim_apps (migrations.test_autodetector.AutodetectorTests)",
            "test_unmanaged_custom_pk (migrations.test_autodetector.AutodetectorTests)",
            "test_unmanaged_delete (migrations.test_autodetector.AutodetectorTests)",
            "test_unmanaged_to_managed (migrations.test_autodetector.AutodetectorTests)"
        ],
        "environment_setup_commit": "0668164b4ac93a5be79f5b87fae83c657124d9ab",
        "patch": "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -927,6 +927,10 @@ def generate_altered_fields(self):\n                 if remote_field_name:\n                     to_field_rename_key = rename_key + (remote_field_name,)\n                     if to_field_rename_key in self.renamed_fields:\n+                        # Repoint both model and field name because to_field\n+                        # inclusion in ForeignKey.deconstruct() is based on\n+                        # both.\n+                        new_field.remote_field.model = old_field.remote_field.model\n                         new_field.remote_field.field_name = old_field.remote_field.field_name\n                 # Handle ForeignObjects which can have multiple from_fields/to_fields.\n                 from_fields = getattr(new_field, 'from_fields', None)\n",
        "pr_link": "https://github.com/django/django/pull/11910"
    }
}