{
    "task_id": "django__django-13757",
    "setup_info": {
        "repo_path": "/media/media0/yuntong/SWE-bench/testbed/django__django/setup_django__django__3.2",
        "env_name": "setup_django__django__3.2",
        "pre_install": [],
        "install": "python -m pip install -e .",
        "test_cmd": "./tests/runtests.py --verbosity 2 model_fields.test_jsonfield"
    },
    "task_info": {
        "instance_id": "django__django-13757",
        "base_commit": "3f140dde51c0fe6c350acb7727bbe489a99f0632",
        "hints_text": "",
        "created_at": "2020-12-09T14:48:53Z",
        "test_patch": "diff --git a/tests/model_fields/test_jsonfield.py b/tests/model_fields/test_jsonfield.py\n--- a/tests/model_fields/test_jsonfield.py\n+++ b/tests/model_fields/test_jsonfield.py\n@@ -586,6 +586,10 @@ def test_isnull_key(self):\n             NullableJSONModel.objects.filter(value__a__isnull=True),\n             self.objs[:3] + self.objs[5:],\n         )\n+        self.assertSequenceEqual(\n+            NullableJSONModel.objects.filter(value__j__isnull=True),\n+            self.objs[:4] + self.objs[5:],\n+        )\n         self.assertSequenceEqual(\n             NullableJSONModel.objects.filter(value__a__isnull=False),\n             [self.objs[3], self.objs[4]],\n",
        "repo": "django/django",
        "problem_statement": "Using __isnull=True on a KeyTransform should not match JSON null on SQLite and Oracle\nDescription\n\t\nThe KeyTransformIsNull lookup borrows the logic from HasKey for isnull=False, which is correct. If isnull=True, the query should only match objects that do not have the key. The query is correct for MariaDB, MySQL, and PostgreSQL. However, on SQLite and Oracle, the query also matches objects that have the key with the value null, which is incorrect.\nTo confirm, edit tests.model_fields.test_jsonfield.TestQuerying.test_isnull_key. For the first assertion, change\n\t\tself.assertSequenceEqual(\n\t\t\tNullableJSONModel.objects.filter(value__a__isnull=True),\n\t\t\tself.objs[:3] + self.objs[5:],\n\t\t)\nto\n\t\tself.assertSequenceEqual(\n\t\t\tNullableJSONModel.objects.filter(value__j__isnull=True),\n\t\t\tself.objs[:4] + self.objs[5:],\n\t\t)\nThe test previously only checks with value__a which could not catch this behavior because the value is not JSON null.\n",
        "version": "3.2",
        "FAIL_TO_PASS": [
            "test_isnull_key (model_fields.test_jsonfield.TestQuerying)"
        ],
        "PASS_TO_PASS": [
            "test_contained_by_unsupported (model_fields.test_jsonfield.TestQuerying)",
            "test_contains_unsupported (model_fields.test_jsonfield.TestQuerying)",
            "test_custom_encoder (model_fields.test_jsonfield.TestValidation)",
            "test_custom_encoder_decoder (model_fields.test_jsonfield.JSONFieldTests)",
            "test_db_check_constraints (model_fields.test_jsonfield.JSONFieldTests)",
            "test_deconstruct (model_fields.test_jsonfield.TestMethods)",
            "test_deconstruct_custom_encoder_decoder (model_fields.test_jsonfield.TestMethods)",
            "test_deep_lookup_array (model_fields.test_jsonfield.TestQuerying)",
            "test_deep_lookup_mixed (model_fields.test_jsonfield.TestQuerying)",
            "test_deep_lookup_objs (model_fields.test_jsonfield.TestQuerying)",
            "test_deep_lookup_transform (model_fields.test_jsonfield.TestQuerying)",
            "test_deep_values (model_fields.test_jsonfield.TestQuerying)",
            "test_dict (model_fields.test_jsonfield.TestSaveLoad)",
            "test_dumping (model_fields.test_jsonfield.TestSerialization)",
            "test_exact (model_fields.test_jsonfield.TestQuerying)",
            "test_exact_complex (model_fields.test_jsonfield.TestQuerying)",
            "test_expression_wrapper_key_transform (model_fields.test_jsonfield.TestQuerying)",
            "test_formfield (model_fields.test_jsonfield.TestFormField)",
            "test_formfield_custom_encoder_decoder (model_fields.test_jsonfield.TestFormField)",
            "test_get_transforms (model_fields.test_jsonfield.TestMethods)",
            "test_has_any_keys (model_fields.test_jsonfield.TestQuerying)",
            "test_has_key (model_fields.test_jsonfield.TestQuerying)",
            "test_has_key_deep (model_fields.test_jsonfield.TestQuerying)",
            "test_has_key_list (model_fields.test_jsonfield.TestQuerying)",
            "test_has_key_null_value (model_fields.test_jsonfield.TestQuerying)",
            "test_has_keys (model_fields.test_jsonfield.TestQuerying)",
            "test_invalid_decoder (model_fields.test_jsonfield.TestValidation)",
            "test_invalid_encoder (model_fields.test_jsonfield.TestValidation)",
            "test_invalid_value (model_fields.test_jsonfield.JSONFieldTests)",
            "test_isnull (model_fields.test_jsonfield.TestQuerying)",
            "test_isnull_key_or_none (model_fields.test_jsonfield.TestQuerying)",
            "test_join_key_transform_annotation_expression (model_fields.test_jsonfield.TestQuerying)",
            "test_json_null_different_from_sql_null (model_fields.test_jsonfield.TestSaveLoad)",
            "test_key_endswith (model_fields.test_jsonfield.TestQuerying)",
            "test_key_escape (model_fields.test_jsonfield.TestQuerying)",
            "test_key_icontains (model_fields.test_jsonfield.TestQuerying)",
            "test_key_iendswith (model_fields.test_jsonfield.TestQuerying)",
            "test_key_iexact (model_fields.test_jsonfield.TestQuerying)",
            "test_key_in (model_fields.test_jsonfield.TestQuerying)",
            "test_key_iregex (model_fields.test_jsonfield.TestQuerying)",
            "test_key_istartswith (model_fields.test_jsonfield.TestQuerying)",
            "test_key_quoted_string (model_fields.test_jsonfield.TestQuerying)",
            "test_key_regex (model_fields.test_jsonfield.TestQuerying)",
            "test_key_sql_injection_escape (model_fields.test_jsonfield.TestQuerying)",
            "test_key_startswith (model_fields.test_jsonfield.TestQuerying)",
            "test_key_transform_annotation_expression (model_fields.test_jsonfield.TestQuerying)",
            "test_key_transform_expression (model_fields.test_jsonfield.TestQuerying)",
            "test_key_transform_raw_expression (model_fields.test_jsonfield.TestQuerying)",
            "test_key_transform_text_lookup_mixin_non_key_transform (model_fields.test_jsonfield.TestMethods)",
            "test_key_values (model_fields.test_jsonfield.TestQuerying)",
            "test_list (model_fields.test_jsonfield.TestSaveLoad)",
            "test_loading (model_fields.test_jsonfield.TestSerialization)",
            "test_lookup_exclude (model_fields.test_jsonfield.TestQuerying)",
            "test_lookup_exclude_nonexistent_key (model_fields.test_jsonfield.TestQuerying)",
            "test_lookups_with_key_transform (model_fields.test_jsonfield.TestQuerying)",
            "test_nested_key_transform_annotation_expression (model_fields.test_jsonfield.TestQuerying)",
            "test_nested_key_transform_expression (model_fields.test_jsonfield.TestQuerying)",
            "test_nested_key_transform_on_subquery (model_fields.test_jsonfield.TestQuerying)",
            "test_nested_key_transform_raw_expression (model_fields.test_jsonfield.TestQuerying)",
            "test_none_key (model_fields.test_jsonfield.TestQuerying)",
            "test_none_key_and_exact_lookup (model_fields.test_jsonfield.TestQuerying)",
            "test_none_key_exclude (model_fields.test_jsonfield.TestQuerying)",
            "test_null (model_fields.test_jsonfield.TestSaveLoad)",
            "test_obj_subquery_lookup (model_fields.test_jsonfield.TestQuerying)",
            "test_order_grouping_custom_decoder (model_fields.test_jsonfield.TestQuerying)",
            "test_ordering_by_transform (model_fields.test_jsonfield.TestQuerying)",
            "test_ordering_grouping_by_count (model_fields.test_jsonfield.TestQuerying)",
            "test_ordering_grouping_by_key_transform (model_fields.test_jsonfield.TestQuerying)",
            "test_primitives (model_fields.test_jsonfield.TestSaveLoad)",
            "test_realistic_object (model_fields.test_jsonfield.TestSaveLoad)",
            "test_shallow_list_lookup (model_fields.test_jsonfield.TestQuerying)",
            "test_shallow_lookup_obj_target (model_fields.test_jsonfield.TestQuerying)",
            "test_shallow_obj_lookup (model_fields.test_jsonfield.TestQuerying)",
            "test_usage_in_subquery (model_fields.test_jsonfield.TestQuerying)",
            "test_validation_error (model_fields.test_jsonfield.TestValidation)",
            "test_xml_serialization (model_fields.test_jsonfield.TestSerialization)"
        ],
        "environment_setup_commit": "65dfb06a1ab56c238cc80f5e1c31f61210c4577d",
        "patch": "diff --git a/django/db/models/fields/json.py b/django/db/models/fields/json.py\n--- a/django/db/models/fields/json.py\n+++ b/django/db/models/fields/json.py\n@@ -366,14 +366,25 @@ def process_rhs(self, compiler, connection):\n class KeyTransformIsNull(lookups.IsNull):\n     # key__isnull=False is the same as has_key='key'\n     def as_oracle(self, compiler, connection):\n+        sql, params = HasKey(\n+            self.lhs.lhs,\n+            self.lhs.key_name,\n+        ).as_oracle(compiler, connection)\n         if not self.rhs:\n-            return HasKey(self.lhs.lhs, self.lhs.key_name).as_oracle(compiler, connection)\n-        return super().as_sql(compiler, connection)\n+            return sql, params\n+        # Column doesn't have a key or IS NULL.\n+        lhs, lhs_params, _ = self.lhs.preprocess_lhs(compiler, connection)\n+        return '(NOT %s OR %s IS NULL)' % (sql, lhs), tuple(params) + tuple(lhs_params)\n \n     def as_sqlite(self, compiler, connection):\n+        template = 'JSON_TYPE(%s, %%s) IS NULL'\n         if not self.rhs:\n-            return HasKey(self.lhs.lhs, self.lhs.key_name).as_sqlite(compiler, connection)\n-        return super().as_sql(compiler, connection)\n+            template = 'JSON_TYPE(%s, %%s) IS NOT NULL'\n+        return HasKey(self.lhs.lhs, self.lhs.key_name).as_sql(\n+            compiler,\n+            connection,\n+            template=template,\n+        )\n \n \n class KeyTransformIn(lookups.In):\n",
        "pr_link": "https://github.com/django/django/pull/13757"
    }
}