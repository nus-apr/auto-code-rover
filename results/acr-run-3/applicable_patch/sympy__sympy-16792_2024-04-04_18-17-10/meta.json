{
    "task_id": "sympy__sympy-16792",
    "setup_info": {
        "repo_path": "/media/media0/yuntong/SWE-bench/testbed/sympy__sympy/setup_sympy__sympy__1.5",
        "env_name": "setup_sympy__sympy__1.5",
        "pre_install": [],
        "install": "python -m pip install -e .",
        "test_cmd": "bin/test -C --verbose sympy/utilities/tests/test_codegen.py"
    },
    "task_info": {
        "instance_id": "sympy__sympy-16792",
        "base_commit": "09786a173e7a0a488f46dd6000177c23e5d24eed",
        "hints_text": "",
        "created_at": "2019-05-09T03:40:54Z",
        "test_patch": "diff --git a/sympy/utilities/tests/test_codegen.py b/sympy/utilities/tests/test_codegen.py\n--- a/sympy/utilities/tests/test_codegen.py\n+++ b/sympy/utilities/tests/test_codegen.py\n@@ -582,6 +582,25 @@ def test_ccode_cse():\n     )\n     assert source == expected\n \n+def test_ccode_unused_array_arg():\n+    x = MatrixSymbol('x', 2, 1)\n+    # x does not appear in output\n+    name_expr = (\"test\", 1.0)\n+    generator = CCodeGen()\n+    result = codegen(name_expr, code_gen=generator, header=False, empty=False, argument_sequence=(x,))\n+    source = result[0][1]\n+    # note: x should appear as (double *)\n+    expected = (\n+        '#include \"test.h\"\\n'\n+        '#include <math.h>\\n'\n+        'double test(double *x) {\\n'\n+        '   double test_result;\\n'\n+        '   test_result = 1.0;\\n'\n+        '   return test_result;\\n'\n+        '}\\n'\n+    )\n+    assert source == expected\n+\n def test_empty_f_code():\n     code_gen = FCodeGen()\n     source = get_string(code_gen.dump_f95, [])\n",
        "repo": "sympy/sympy",
        "problem_statement": "autowrap with cython backend fails when array arguments do not appear in wrapped expr\nWhen using the cython backend for autowrap, it appears that the code is not correctly generated when the function in question has array arguments that do not appear in the final expression. A minimal counterexample is:\r\n\r\n```python\r\nfrom sympy.utilities.autowrap import autowrap\r\nfrom sympy import MatrixSymbol\r\nimport numpy as np\r\n\r\nx = MatrixSymbol('x', 2, 1)\r\nexpr = 1.0\r\nf = autowrap(expr, args=(x,), backend='cython')\r\n\r\nf(np.array([[1.0, 2.0]]))\r\n```\r\n\r\nThis should of course return `1.0` but instead fails with:\r\n```python\r\nTypeError: only size-1 arrays can be converted to Python scalars\r\n```\r\n\r\nA little inspection reveals that this is because the corresponding C function is generated with an incorrect signature:\r\n\r\n```C\r\ndouble autofunc(double x) {\r\n\r\n   double autofunc_result;\r\n   autofunc_result = 1.0;\r\n   return autofunc_result;\r\n\r\n}\r\n```\r\n\r\n(`x` should be `double *`, not `double` in this case)\r\n\r\nI've found that this error won't occur so long as `expr` depends at least in part on each argument. For example this slight modification of the above counterexample works perfectly:\r\n\r\n```python\r\nfrom sympy.utilities.autowrap import autowrap\r\nfrom sympy import MatrixSymbol\r\nimport numpy as np\r\n\r\nx = MatrixSymbol('x', 2, 1)\r\n# now output depends on x\r\nexpr = x[0,0]\r\nf = autowrap(expr, args=(x,), backend='cython')\r\n\r\n# returns 1.0 as expected, without failure\r\nf(np.array([[1.0, 2.0]]))\r\n```\r\n\r\nThis may seem like a silly issue (\"why even have `x` as an argument if it doesn't appear in the expression you're trying to evaluate?\"). But of course in interfacing with external libraries (e.g. for numerical integration), one often needs functions to have a pre-defined signature regardless of whether a given argument contributes to the output.\r\n\r\nI think I've identified the problem in `codegen` and will suggest a PR shortly.\n",
        "version": "1.5",
        "FAIL_TO_PASS": [
            "test_ccode_unused_array_arg"
        ],
        "PASS_TO_PASS": [
            "test_Routine_argument_order",
            "test_ansi_math1_codegen",
            "test_ansi_math2_codegen",
            "test_c_code_argument_order",
            "test_c_code_reserved_words",
            "test_c_fortran_omit_routine_name",
            "test_c_with_printer",
            "test_ccode_cse",
            "test_ccode_matrixsymbol_slice",
            "test_ccode_results_named_ordered",
            "test_check_case",
            "test_check_case_false_positive",
            "test_complicated_codegen",
            "test_complicated_codegen_f95",
            "test_custom_codegen",
            "test_dummy_loops_c",
            "test_dummy_loops_f95",
            "test_empty_c_code",
            "test_empty_c_code_with_comment",
            "test_empty_c_header",
            "test_empty_f_code",
            "test_empty_f_code_with_header",
            "test_empty_f_header",
            "test_erf_f_code",
            "test_f_code_argument_order",
            "test_f_code_call_signature_wrap",
            "test_fcode_matrix_output",
            "test_fcode_matrixsymbol_slice",
            "test_fcode_matrixsymbol_slice_autoname",
            "test_fcode_results_named_ordered",
            "test_global_vars",
            "test_inline_function",
            "test_intrinsic_math2_codegen",
            "test_intrinsic_math_codegen",
            "test_loops",
            "test_loops_InOut",
            "test_loops_c",
            "test_multiple_results_c",
            "test_multiple_results_f",
            "test_no_results_c",
            "test_no_results_f",
            "test_numbersymbol_c_code",
            "test_numbersymbol_f_code",
            "test_output_arg_c",
            "test_output_arg_c_reserved_words",
            "test_output_arg_f",
            "test_partial_loops_c",
            "test_partial_loops_f",
            "test_simple_c_code",
            "test_simple_c_codegen",
            "test_simple_c_header",
            "test_simple_f_code",
            "test_simple_f_codegen",
            "test_simple_f_header"
        ],
        "environment_setup_commit": "70381f282f2d9d039da860e391fe51649df2779d",
        "patch": "diff --git a/sympy/utilities/codegen.py b/sympy/utilities/codegen.py\n--- a/sympy/utilities/codegen.py\n+++ b/sympy/utilities/codegen.py\n@@ -695,6 +695,11 @@ def routine(self, name, expr, argument_sequence=None, global_vars=None):\n         arg_list = []\n \n         # setup input argument list\n+\n+        # helper to get dimensions for data for array-like args\n+        def dimensions(s):\n+            return [(S.Zero, dim - 1) for dim in s.shape]\n+\n         array_symbols = {}\n         for array in expressions.atoms(Indexed) | local_expressions.atoms(Indexed):\n             array_symbols[array.base.label] = array\n@@ -703,11 +708,8 @@ def routine(self, name, expr, argument_sequence=None, global_vars=None):\n \n         for symbol in sorted(symbols, key=str):\n             if symbol in array_symbols:\n-                dims = []\n                 array = array_symbols[symbol]\n-                for dim in array.shape:\n-                    dims.append((S.Zero, dim - 1))\n-                metadata = {'dimensions': dims}\n+                metadata = {'dimensions': dimensions(array)}\n             else:\n                 metadata = {}\n \n@@ -739,7 +741,11 @@ def routine(self, name, expr, argument_sequence=None, global_vars=None):\n                 try:\n                     new_args.append(name_arg_dict[symbol])\n                 except KeyError:\n-                    new_args.append(InputArgument(symbol))\n+                    if isinstance(symbol, (IndexedBase, MatrixSymbol)):\n+                        metadata = {'dimensions': dimensions(symbol)}\n+                    else:\n+                        metadata = {}\n+                    new_args.append(InputArgument(symbol, **metadata))\n             arg_list = new_args\n \n         return Routine(name, arg_list, return_val, local_vars, global_vars)\n",
        "pr_link": "https://github.com/sympy/sympy/pull/16792"
    }
}