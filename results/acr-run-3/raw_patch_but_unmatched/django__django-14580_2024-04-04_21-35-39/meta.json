{
    "task_id": "django__django-14580",
    "setup_info": {
        "repo_path": "/media/media0/yuntong/SWE-bench/testbed/django__django/setup_django__django__4.0",
        "env_name": "setup_django__django__4.0",
        "pre_install": [],
        "install": "python -m pip install -e .",
        "test_cmd": "./tests/runtests.py --verbosity 2 migrations.test_writer"
    },
    "task_info": {
        "instance_id": "django__django-14580",
        "base_commit": "36fa071d6ebd18a61c4d7f1b5c9d17106134bd44",
        "hints_text": "I could reproduce the issue with 3.2.4, 2.2.24 and the main branch. For what it's worth, the issue doesn't occur if the class MyModel does inherit from MyMixin.\nMyBaseModel is not necessary to reproduce this issue, it's due to the fact that MyModel doesn't have fields from django.db.models and has custom bases. It looks like an issue with special casing of models.Model in TypeSerializer. Proposed patch diff --git a/django/db/migrations/serializer.py b/django/db/migrations/serializer.py index e19c881cda..6e78462e95 100644 --- a/django/db/migrations/serializer.py +++ b/django/db/migrations/serializer.py @@ -273,7 +273,7 @@ class TupleSerializer(BaseSequenceSerializer): class TypeSerializer(BaseSerializer): def serialize(self): special_cases = [ - (models.Model, \"models.Model\", []), + (models.Model, \"models.Model\", ['from django.db import models']), (type(None), 'type(None)', []), ] for case, string, imports in special_cases:",
        "created_at": "2021-07-01T07:38:03Z",
        "test_patch": "diff --git a/tests/migrations/test_writer.py b/tests/migrations/test_writer.py\n--- a/tests/migrations/test_writer.py\n+++ b/tests/migrations/test_writer.py\n@@ -658,6 +658,13 @@ def test_serialize_functools_partialmethod(self):\n     def test_serialize_type_none(self):\n         self.assertSerializedEqual(type(None))\n \n+    def test_serialize_type_model(self):\n+        self.assertSerializedEqual(models.Model)\n+        self.assertSerializedResultEqual(\n+            MigrationWriter.serialize(models.Model),\n+            (\"('models.Model', {'from django.db import models'})\", set()),\n+        )\n+\n     def test_simple_migration(self):\n         \"\"\"\n         Tests serializing a simple migration.\n",
        "repo": "django/django",
        "problem_statement": "Missing import statement in generated migration (NameError: name 'models' is not defined)\nDescription\n\t\nI found a bug in Django's latest release: 3.2.4. \nGiven the following contents of models.py:\nfrom django.db import models\nclass MyField(models.TextField):\n\tpass\nclass MyBaseModel(models.Model):\n\tclass Meta:\n\t\tabstract = True\nclass MyMixin:\n\tpass\nclass MyModel(MyMixin, MyBaseModel):\n\tname = MyField(primary_key=True)\nThe makemigrations command will generate the following migration file:\n# Generated by Django 3.2.4 on 2021-06-30 19:13\nimport app.models\nfrom django.db import migrations\nclass Migration(migrations.Migration):\n\tinitial = True\n\tdependencies = [\n\t]\n\toperations = [\n\t\tmigrations.CreateModel(\n\t\t\tname='MyModel',\n\t\t\tfields=[\n\t\t\t\t('name', app.models.MyField(primary_key=True, serialize=False)),\n\t\t\t],\n\t\t\toptions={\n\t\t\t\t'abstract': False,\n\t\t\t},\n\t\t\tbases=(app.models.MyMixin, models.Model),\n\t\t),\n\t]\nWhich will then fail with the following error:\n File \"/home/jj/django_example/app/migrations/0001_initial.py\", line 7, in <module>\n\tclass Migration(migrations.Migration):\n File \"/home/jj/django_example/app/migrations/0001_initial.py\", line 23, in Migration\n\tbases=(app.models.MyMixin, models.Model),\nNameError: name 'models' is not defined\nExpected behavior: Django generates a migration file that is valid Python.\nActual behavior: Django generates a migration file that is missing an import statement.\nI think this is a bug of the module django.db.migrations.writer, but I'm not sure. I will be happy to assist with debugging.\nThanks for your attention,\nJaap Joris\n",
        "version": "4.0",
        "FAIL_TO_PASS": [
            "test_serialize_type_model (migrations.test_writer.WriterTests)"
        ],
        "PASS_TO_PASS": [
            "#24155 - Tests ordering of imports.",
            "A reference in a local scope can't be serialized.",
            "An unbound method used within a class body can be serialized.",
            "Make sure compiled regex can be serialized.",
            "Test comments at top of file.",
            "Tests serializing a simple migration.",
            "Ticket #22679: makemigrations generates invalid code for (an empty",
            "Ticket #22943: Test serialization of class-based validators, including",
            "django.db.models shouldn't be imported if unused.",
            "test_args_kwargs_signature (migrations.test_writer.OperationWriterTests)",
            "test_args_signature (migrations.test_writer.OperationWriterTests)",
            "test_custom_operation (migrations.test_writer.WriterTests)",
            "test_deconstruct_class_arguments (migrations.test_writer.WriterTests)",
            "test_empty_signature (migrations.test_writer.OperationWriterTests)",
            "test_expand_args_signature (migrations.test_writer.OperationWriterTests)",
            "test_kwargs_signature (migrations.test_writer.OperationWriterTests)",
            "test_migration_path (migrations.test_writer.WriterTests)",
            "test_multiline_args_signature (migrations.test_writer.OperationWriterTests)",
            "test_nested_args_signature (migrations.test_writer.OperationWriterTests)",
            "test_nested_operation_expand_args_signature (migrations.test_writer.OperationWriterTests)",
            "test_register_non_serializer (migrations.test_writer.WriterTests)",
            "test_register_serializer (migrations.test_writer.WriterTests)",
            "test_serialize_builtin_types (migrations.test_writer.WriterTests)",
            "test_serialize_builtins (migrations.test_writer.WriterTests)",
            "test_serialize_choices (migrations.test_writer.WriterTests)",
            "test_serialize_collections (migrations.test_writer.WriterTests)",
            "test_serialize_constants (migrations.test_writer.WriterTests)",
            "test_serialize_datetime (migrations.test_writer.WriterTests)",
            "test_serialize_enums (migrations.test_writer.WriterTests)",
            "test_serialize_fields (migrations.test_writer.WriterTests)",
            "test_serialize_frozensets (migrations.test_writer.WriterTests)",
            "test_serialize_functions (migrations.test_writer.WriterTests)",
            "test_serialize_functools_partial (migrations.test_writer.WriterTests)",
            "test_serialize_functools_partialmethod (migrations.test_writer.WriterTests)",
            "test_serialize_iterators (migrations.test_writer.WriterTests)",
            "test_serialize_lazy_objects (migrations.test_writer.WriterTests)",
            "test_serialize_managers (migrations.test_writer.WriterTests)",
            "test_serialize_multiline_strings (migrations.test_writer.WriterTests)",
            "test_serialize_nested_class (migrations.test_writer.WriterTests)",
            "test_serialize_numbers (migrations.test_writer.WriterTests)",
            "test_serialize_path_like (migrations.test_writer.WriterTests)",
            "test_serialize_pathlib (migrations.test_writer.WriterTests)",
            "test_serialize_range (migrations.test_writer.WriterTests)",
            "test_serialize_set (migrations.test_writer.WriterTests)",
            "test_serialize_settings (migrations.test_writer.WriterTests)",
            "test_serialize_strings (migrations.test_writer.WriterTests)",
            "test_serialize_timedelta (migrations.test_writer.WriterTests)",
            "test_serialize_type_none (migrations.test_writer.WriterTests)",
            "test_serialize_uuid (migrations.test_writer.WriterTests)"
        ],
        "environment_setup_commit": "475cffd1d64c690cdad16ede4d5e81985738ceb4",
        "patch": "diff --git a/django/db/migrations/serializer.py b/django/db/migrations/serializer.py\n--- a/django/db/migrations/serializer.py\n+++ b/django/db/migrations/serializer.py\n@@ -273,7 +273,7 @@ def _format(self):\n class TypeSerializer(BaseSerializer):\n     def serialize(self):\n         special_cases = [\n-            (models.Model, \"models.Model\", []),\n+            (models.Model, \"models.Model\", ['from django.db import models']),\n             (type(None), 'type(None)', []),\n         ]\n         for case, string, imports in special_cases:\n",
        "pr_link": "https://github.com/django/django/pull/14580"
    }
}