{
    "task_id": "matplotlib__matplotlib-25332",
    "setup_info": {
        "repo_path": "/media/media0/yuntong/SWE-bench/testbed/matplotlib__matplotlib/setup_matplotlib__matplotlib__3.7",
        "env_name": "setup_matplotlib__matplotlib__3.7",
        "pre_install": [],
        "install": "python -m pip install -e .",
        "test_cmd": "pytest --no-header -rA --tb=no -p no:cacheprovider lib/matplotlib/tests/test_pickle.py"
    },
    "task_info": {
        "instance_id": "matplotlib__matplotlib-25332",
        "base_commit": "66ba515e671638971bd11a34cff12c107a437e0b",
        "hints_text": "As you've noted, pickling is pretty fragile.  Do you _need_ to pickle?  ",
        "created_at": "2023-02-26T11:18:40Z",
        "test_patch": "diff --git a/lib/matplotlib/tests/test_pickle.py b/lib/matplotlib/tests/test_pickle.py\n--- a/lib/matplotlib/tests/test_pickle.py\n+++ b/lib/matplotlib/tests/test_pickle.py\n@@ -58,6 +58,7 @@ def _generate_complete_test_figure(fig_ref):\n     # Ensure lists also pickle correctly.\n     plt.subplot(3, 3, 1)\n     plt.plot(list(range(10)))\n+    plt.ylabel(\"hello\")\n \n     plt.subplot(3, 3, 2)\n     plt.contourf(data, hatches=['//', 'ooo'])\n@@ -68,6 +69,7 @@ def _generate_complete_test_figure(fig_ref):\n \n     plt.subplot(3, 3, 4)\n     plt.imshow(data)\n+    plt.ylabel(\"hello\\nworld!\")\n \n     plt.subplot(3, 3, 5)\n     plt.pcolor(data)\n@@ -89,6 +91,8 @@ def _generate_complete_test_figure(fig_ref):\n     plt.subplot(3, 3, 9)\n     plt.errorbar(x, x * -0.5, xerr=0.2, yerr=0.4)\n \n+    fig_ref.align_ylabels()  # Test handling of _align_label_groups Groupers.\n+\n \n @mpl.style.context(\"default\")\n @check_figures_equal(extensions=[\"png\"])\n",
        "repo": "matplotlib/matplotlib",
        "problem_statement": "[Bug]: Unable to pickle figure with aligned labels\n### Bug summary\r\n\r\n Unable to pickle figure after calling `align_labels()`\r\n\r\n### Code for reproduction\r\n\r\n```python\r\nimport matplotlib.pyplot as plt\r\nimport pickle\r\n\r\nfig = plt.figure()\r\nax1 = fig.add_subplot(211)\r\nax2 = fig.add_subplot(212)\r\ntime=[0,1,2,3,4]\r\nspeed=[40000,4300,4500,4700,4800]\r\nacc=[10,11,12,13,14]\r\nax1.plot(time,speed)\r\nax1.set_ylabel('speed')\r\nax2.plot(time,acc)\r\nax2.set_ylabel('acc')\r\n\r\nfig.align_labels() ##pickling works after removing this line \r\n\r\npickle.dumps(fig)\r\nplt.show()\r\n```\r\n\r\n\r\n### Actual outcome\r\n```\r\nalign.py\", line 16\r\npickle.dumps(fig)\r\nTypeError: cannot pickle 'weakref.ReferenceType' object\r\n```\r\n### Expected outcome\r\n\r\nPickling successful\r\n\r\n### Additional information\r\n\r\n_No response_\r\n\r\n### Operating system\r\n\r\nWindows\r\n\r\n### Matplotlib Version\r\n\r\n3.7.0\r\n\r\n### Matplotlib Backend\r\n\r\n_No response_\r\n\r\n### Python version\r\n\r\n_No response_\r\n\r\n### Jupyter version\r\n\r\n_No response_\r\n\r\n### Installation\r\n\r\nNone\n",
        "version": "3.7",
        "FAIL_TO_PASS": [
            "lib/matplotlib/tests/test_pickle.py::test_complete[png]"
        ],
        "PASS_TO_PASS": [
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap0]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap100]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap101]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap102]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap103]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap104]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap105]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap106]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap107]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap108]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap109]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap10]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap110]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap111]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap112]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap113]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap114]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap115]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap116]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap117]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap118]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap119]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap11]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap120]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap121]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap122]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap123]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap124]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap125]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap126]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap127]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap128]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap129]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap12]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap130]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap131]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap132]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap133]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap134]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap135]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap136]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap137]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap138]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap139]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap13]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap140]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap141]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap142]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap143]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap144]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap145]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap146]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap147]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap148]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap149]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap14]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap150]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap151]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap152]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap153]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap154]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap155]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap156]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap157]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap158]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap159]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap15]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap160]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap161]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap162]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap163]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap164]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap165]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap16]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap17]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap18]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap19]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap1]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap20]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap21]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap22]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap23]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap24]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap25]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap26]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap27]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap28]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap29]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap2]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap30]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap31]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap32]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap33]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap34]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap35]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap36]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap37]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap38]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap39]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap3]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap40]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap41]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap42]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap43]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap44]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap45]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap46]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap47]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap48]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap49]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap4]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap50]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap51]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap52]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap53]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap54]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap55]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap56]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap57]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap58]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap59]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap5]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap60]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap61]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap62]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap63]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap64]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap65]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap66]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap67]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap68]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap69]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap6]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap70]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap71]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap72]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap73]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap74]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap75]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap76]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap77]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap78]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap79]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap7]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap80]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap81]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap82]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap83]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap84]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap85]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap86]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap87]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap88]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap89]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap8]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap90]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap91]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap92]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap93]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap94]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap95]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap96]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap97]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap98]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap99]",
            "lib/matplotlib/tests/test_pickle.py::test_cmap[cmap9]",
            "lib/matplotlib/tests/test_pickle.py::test_dynamic_norm",
            "lib/matplotlib/tests/test_pickle.py::test_gcf",
            "lib/matplotlib/tests/test_pickle.py::test_image",
            "lib/matplotlib/tests/test_pickle.py::test_inset_and_secondary",
            "lib/matplotlib/tests/test_pickle.py::test_mpl_toolkits",
            "lib/matplotlib/tests/test_pickle.py::test_no_pyplot",
            "lib/matplotlib/tests/test_pickle.py::test_polar",
            "lib/matplotlib/tests/test_pickle.py::test_renderer",
            "lib/matplotlib/tests/test_pickle.py::test_rrulewrapper",
            "lib/matplotlib/tests/test_pickle.py::test_shared",
            "lib/matplotlib/tests/test_pickle.py::test_simple",
            "lib/matplotlib/tests/test_pickle.py::test_standard_norm",
            "lib/matplotlib/tests/test_pickle.py::test_transform",
            "lib/matplotlib/tests/test_pickle.py::test_unpickle_canvas",
            "lib/matplotlib/tests/test_pickle.py::test_vertexselector"
        ],
        "environment_setup_commit": "0849036fd992a2dd133a0cffc3f84f58ccf1840f",
        "patch": "diff --git a/lib/matplotlib/cbook.py b/lib/matplotlib/cbook.py\n--- a/lib/matplotlib/cbook.py\n+++ b/lib/matplotlib/cbook.py\n@@ -788,6 +788,19 @@ class Grouper:\n     def __init__(self, init=()):\n         self._mapping = {weakref.ref(x): [weakref.ref(x)] for x in init}\n \n+    def __getstate__(self):\n+        return {\n+            **vars(self),\n+            # Convert weak refs to strong ones.\n+            \"_mapping\": {k(): [v() for v in vs] for k, vs in self._mapping.items()},\n+        }\n+\n+    def __setstate__(self, state):\n+        vars(self).update(state)\n+        # Convert strong refs to weak ones.\n+        self._mapping = {weakref.ref(k): [*map(weakref.ref, vs)]\n+                         for k, vs in self._mapping.items()}\n+\n     def __contains__(self, item):\n         return weakref.ref(item) in self._mapping\n \n",
        "pr_link": "https://github.com/matplotlib/matplotlib/pull/25332"
    }
}