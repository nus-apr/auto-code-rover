{
    "task_id": "django__django-10914",
    "setup_info": {
        "repo_path": "/media/media0/yuntong/SWE-bench/testbed/django__django/setup_django__django__3.0",
        "env_name": "setup_django__django__3.0",
        "pre_install": [],
        "install": "python -m pip install -e .",
        "test_cmd": "./tests/runtests.py --verbosity 2 test_utils.tests"
    },
    "task_info": {
        "instance_id": "django__django-10914",
        "base_commit": "e7fd69d051eaa67cb17f172a39b57253e9cb831a",
        "hints_text": "I think you're talking about ef70af77ec53160d5ffa060c1bdf5ed93322d84f (#28540). I guess the question is whether or not that documentation should be duplicated elsewhere.\nThank you Tim, this is precisely what I was looking for! I can only see one issue with the current docs (if you excuse me for bothering you with such minor details). \u200bThe documentation for the FILE_UPLOAD_PERMISSIONS setting reads: If this isn\u2019t given or is None, you\u2019ll get operating-system dependent behavior. On most platforms, temporary files will have a mode of 0o600, and files saved from memory will be saved using the system\u2019s standard umask. As I would understand this text, only temporary files get a mode of 0o600. I would then ask myself: \"Why should I care about temporary files, they should be gone anyway after the file is uploaded?\" and skip setting FILE_UPLOAD_PERMISSIONS. What is important but is not properly conveyed to the user is that not only temporary files themselves, but also the actual files which end up in the media folder get permissions of 0o600. Currently a developer can only discover this either by careful reading of the Deployment checklist page (manage.py check --deploy does not seem to check FILE_UPLOAD_PERMISSIONS) or by hitting the inconsistent permissions accidentally (like I did). I propose to unify the docs for FILE_UPLOAD_PERMISSIONS on the Settings page and the Deployment checklist page like this: \u200bhttps://gist.github.com/earshinov/0340f741189a14d4fd10e3e902203ad6/revisions#diff-14151589d5408f8b64b7e0e580770f0e Pros: It makes more clear that one gets different permissions for the *uploaded* files. It makes the docs more unified and thus easier to synchronously change in the future if/when required. I recognize that my edits might seem too minor and insignificant to be worth the hassle of editing the docs, committing, re-publishing them etc., but still I hope you will find them useful enough to be integrated into the official docs.\nNow that I think about, maybe Django could provide # <Commentary about inconsistent permissions when this setting is omitted> FILE_UPLOAD_PERMISSINS=0o600 in the \u200bdefault project settings so that developers don't miss it? 600 seems a reasonable default, particularly because people would get 600 anyway (at least on some operating systems) when the TemporaryFileUploadHandler is engaged.\nSince this has come up again, I've suggested on django-developers (\u200bhttps://groups.google.com/d/topic/django-developers/h9XbQAPv5-I/discussion) that we adjust the FILE_UPLOAD_PERMISSION default to 0o644 (This was the conclusion I eventually came to from the discussion on #28540.) Lets see what people say there.\nThus far, no great objections on the mailing list to adjusting the FILE_UPLOAD_PERMISSION default. Thus I'm going to rename this and Accept on that basis. A PR would need to: Adjust the default. Add a Breaking Change note to releases/2.2.txt (on the assumption we can get it in for then.) \u2014 This should include a set to None to restore previous behaviour' type comment. Adjust the references in the settings docs and deployment checklist. Make sure any other references are adjusted.\nReplying to Carlton Gibson: Thus far, no great objections on the mailing list to adjusting the FILE_UPLOAD_PERMISSION default. Thus I'm going to rename this and Accept on that basis. Thank you! Hopefully, this change will prevent confusion and unpleasant surprises for Django users in the future.\nHello everyone, I would like to work on this. But before that there are few important questions: There is a related setting called FILE_UPLOAD_DIRECTORY_PERMISSIONS. Its document says that This value mirrors the functionality and caveats of the FILE_UPLOAD_PERMISSIONS setting. Shall we also change its default from None to 0o644(Please suggest if something different should be provided for directories) and update its document as well? Since 2.2 pre-release branch is now in feature freeze state, Shall we move the change to 3.0 version? On a side note, some tests must be refactored for new values for both of these settings. I think that's alright.\nThat note is referring to that non-leaf directories are created using the process umask. (See \u200b`makedirs()` docs.) This is similar to FILE_UPLOAD_PERMISSIONS, when not using the temporary file upload handler. The underlying issue here is the inconsistency in file permissions, depending on the file size, when using the default settings that Django provides. There is no such inconsistency with directory permissions. As such changes should not be needed to FILE_UPLOAD_DIRECTORY_PERMISSIONS. (Any issues there would need to be addressed under a separate ticket.)\nReplying to Carlton Gibson: I see and understand the issue better now. Thanks for the clarification. I'll make the changes as you have suggested in your previous comment. Only question remaining is about introducing this change in 3.0 version. Shall we move it to 3.0 release?\nShall we move it to 3.0 release? Yes please.",
        "created_at": "2019-01-30T13:13:20Z",
        "test_patch": "diff --git a/tests/test_utils/tests.py b/tests/test_utils/tests.py\n--- a/tests/test_utils/tests.py\n+++ b/tests/test_utils/tests.py\n@@ -1099,7 +1099,7 @@ def test_override_file_upload_permissions(self):\n         the file_permissions_mode attribute of\n         django.core.files.storage.default_storage.\n         \"\"\"\n-        self.assertIsNone(default_storage.file_permissions_mode)\n+        self.assertEqual(default_storage.file_permissions_mode, 0o644)\n         with self.settings(FILE_UPLOAD_PERMISSIONS=0o777):\n             self.assertEqual(default_storage.file_permissions_mode, 0o777)\n \n",
        "repo": "django/django",
        "problem_statement": "Set default FILE_UPLOAD_PERMISSION to 0o644.\nDescription\n\t\nHello,\nAs far as I can see, the \u200bFile Uploads documentation page does not mention any permission issues.\nWhat I would like to see is a warning that in absence of explicitly configured FILE_UPLOAD_PERMISSIONS, the permissions for a file uploaded to FileSystemStorage might not be consistent depending on whether a MemoryUploadedFile or a TemporaryUploadedFile was used for temporary storage of the uploaded data (which, with the default FILE_UPLOAD_HANDLERS, in turn depends on the uploaded data size).\nThe tempfile.NamedTemporaryFile + os.rename sequence causes the resulting file permissions to be 0o0600 on some systems (I experience it here on CentOS 7.4.1708 and Python 3.6.5). In all probability, the implementation of Python's built-in tempfile module explicitly sets such permissions for temporary files due to security considerations.\nI found mentions of this issue \u200bon GitHub, but did not manage to find any existing bug report in Django's bug tracker.\n",
        "version": "3.0",
        "FAIL_TO_PASS": [
            "test_override_file_upload_permissions (test_utils.tests.OverrideSettingsTests)"
        ],
        "PASS_TO_PASS": [
            "An exception is setUp() is reraised after disable() is called.",
            "assertRaisesMessage shouldn't interpret RE special chars.",
            "test_all (test_utils.tests.DatabaseAliasTests)",
            "test_allowed_database_chunked_cursor_queries (test_utils.tests.AllowedDatabaseQueriesTests)",
            "test_allowed_database_queries (test_utils.tests.AllowedDatabaseQueriesTests)",
            "test_allowed_hosts (test_utils.tests.SetupTestEnvironmentTests)",
            "test_assert_field_output (test_utils.tests.AssertFieldOutputTests)",
            "test_assert_num_queries (test_utils.tests.AssertNumQueriesTests)",
            "test_assert_num_queries_with_client (test_utils.tests.AssertNumQueriesTests)",
            "test_assert_raises_message (test_utils.tests.AssertRaisesMsgTest)",
            "test_assert_used_on_http_response (test_utils.tests.AssertTemplateUsedContextManagerTests)",
            "test_attributes (test_utils.tests.HTMLEqualTests)",
            "test_callable (test_utils.tests.AssertWarnsMessageTests)",
            "test_class_decoration (test_utils.tests.IsolatedAppsTests)",
            "test_close_match (test_utils.tests.DatabaseAliasTests)",
            "test_comment_root (test_utils.tests.XMLEqualTests)",
            "test_complex_examples (test_utils.tests.HTMLEqualTests)",
            "test_contains_html (test_utils.tests.HTMLEqualTests)",
            "test_context_manager (test_utils.tests.AssertWarnsMessageTests)",
            "test_context_manager (test_utils.tests.IsolatedAppsTests)",
            "test_context_manager_failure (test_utils.tests.AssertWarnsMessageTests)",
            "test_count (test_utils.tests.HTMLEqualTests)",
            "test_custom_required_message (test_utils.tests.AssertFieldOutputTests)",
            "test_disallowed_database_chunked_cursor_queries (test_utils.tests.DisallowedDatabaseQueriesTests)",
            "test_disallowed_database_connections (test_utils.tests.DisallowedDatabaseQueriesTests)",
            "test_disallowed_database_queries (test_utils.tests.DisallowedDatabaseQueriesTests)",
            "test_equal (test_utils.tests.AssertURLEqualTests)",
            "test_equal_parsing_errors (test_utils.tests.JSONEqualTests)",
            "test_error_message (test_utils.tests.AssertTemplateUsedContextManagerTests)",
            "test_failure (test_utils.tests.AssertNumQueriesContextManagerTests)",
            "test_failure (test_utils.tests.AssertTemplateUsedContextManagerTests)",
            "test_failure (test_utils.tests.CaptureQueriesContextManagerTests)",
            "test_failure_in_setUpTestData_should_rollback_transaction (test_utils.tests.TestBadSetUpTestData)",
            "test_html_contain (test_utils.tests.HTMLEqualTests)",
            "test_html_parser (test_utils.tests.HTMLEqualTests)",
            "test_ignore_comments (test_utils.tests.HTMLEqualTests)",
            "test_ignores_connection_configuration_queries (test_utils.tests.AssertNumQueriesUponConnectionTests)",
            "test_installed_apps (test_utils.tests.IsolatedAppsTests)",
            "test_match (test_utils.tests.DatabaseAliasTests)",
            "test_message (test_utils.tests.AssertURLEqualTests)",
            "test_method_decoration (test_utils.tests.IsolatedAppsTests)",
            "test_missing_default_databases (test_utils.tests.SkippingClassTestCase)",
            "test_msg_prefix (test_utils.tests.AssertURLEqualTests)",
            "test_nested (test_utils.tests.CaptureQueriesContextManagerTests)",
            "test_nested (test_utils.tests.IsolatedAppsTests)",
            "test_nested_usage (test_utils.tests.AssertTemplateUsedContextManagerTests)",
            "test_no_close_match (test_utils.tests.DatabaseAliasTests)",
            "test_not_equal (test_utils.tests.AssertURLEqualTests)",
            "test_not_equal_parsing_errors (test_utils.tests.JSONEqualTests)",
            "test_not_used (test_utils.tests.AssertTemplateUsedContextManagerTests)",
            "test_ordered (test_utils.tests.AssertQuerysetEqualTests)",
            "test_override_database_routers (test_utils.tests.OverrideSettingsTests)",
            "test_override_file_upload_directory_permissions (test_utils.tests.OverrideSettingsTests)",
            "test_override_media_root (test_utils.tests.OverrideSettingsTests)",
            "test_override_media_url (test_utils.tests.OverrideSettingsTests)",
            "test_override_static_root (test_utils.tests.OverrideSettingsTests)",
            "test_override_static_url (test_utils.tests.OverrideSettingsTests)",
            "test_override_staticfiles_dirs (test_utils.tests.OverrideSettingsTests)",
            "test_override_staticfiles_finders (test_utils.tests.OverrideSettingsTests)",
            "test_override_staticfiles_storage (test_utils.tests.OverrideSettingsTests)",
            "test_parse_html_in_script (test_utils.tests.HTMLEqualTests)",
            "test_parsing_errors (test_utils.tests.HTMLEqualTests)",
            "test_parsing_errors (test_utils.tests.XMLEqualTests)",
            "test_repeated_values (test_utils.tests.AssertQuerysetEqualTests)",
            "test_self_closing_tags (test_utils.tests.HTMLEqualTests)",
            "test_setup_test_environment_calling_more_than_once (test_utils.tests.SetupTestEnvironmentTests)",
            "test_simple (test_utils.tests.AssertNumQueriesContextManagerTests)",
            "test_simple (test_utils.tests.CaptureQueriesContextManagerTests)",
            "test_simple_equal (test_utils.tests.JSONEqualTests)",
            "test_simple_equal (test_utils.tests.XMLEqualTests)",
            "test_simple_equal_html (test_utils.tests.HTMLEqualTests)",
            "test_simple_equal_raise (test_utils.tests.JSONEqualTests)",
            "test_simple_equal_raise (test_utils.tests.XMLEqualTests)",
            "test_simple_equal_raises_message (test_utils.tests.XMLEqualTests)",
            "test_simple_equal_unordered (test_utils.tests.JSONEqualTests)",
            "test_simple_equal_unordered (test_utils.tests.XMLEqualTests)",
            "test_simple_equal_with_leading_or_trailing_whitespace (test_utils.tests.XMLEqualTests)",
            "test_simple_not_equal (test_utils.tests.JSONEqualTests)",
            "test_simple_not_equal (test_utils.tests.XMLEqualTests)",
            "test_simple_not_equal_raise (test_utils.tests.JSONEqualTests)",
            "test_simple_not_equal_raise (test_utils.tests.XMLEqualTests)",
            "test_simple_not_equal_with_whitespace_in_the_middle (test_utils.tests.XMLEqualTests)",
            "test_skip_class_unless_db_feature (test_utils.tests.SkippingClassTestCase)",
            "test_skip_if_db_feature (test_utils.tests.SkippingTestCase)",
            "test_skip_unless_db_feature (test_utils.tests.SkippingTestCase)",
            "test_special_re_chars (test_utils.tests.AssertWarnsMessageTests)",
            "test_transform (test_utils.tests.AssertQuerysetEqualTests)",
            "test_undefined_order (test_utils.tests.AssertQuerysetEqualTests)",
            "test_unequal_html (test_utils.tests.HTMLEqualTests)",
            "test_unicode_handling (test_utils.tests.HTMLEqualTests)",
            "test_unordered (test_utils.tests.AssertQuerysetEqualTests)",
            "test_urlconf_cache (test_utils.tests.OverrideSettingsTests)",
            "test_urlconf_first (test_utils.tests.OverrideSettingsTests)",
            "test_urlconf_second (test_utils.tests.OverrideSettingsTests)",
            "test_usage (test_utils.tests.AssertTemplateUsedContextManagerTests)",
            "test_with_client (test_utils.tests.AssertNumQueriesContextManagerTests)",
            "test_with_client (test_utils.tests.CaptureQueriesContextManagerTests)",
            "test_within (test_utils.tests.CaptureQueriesContextManagerTests)"
        ],
        "environment_setup_commit": "419a78300f7cd27611196e1e464d50fd0385ff27",
        "patch": "diff --git a/django/conf/global_settings.py b/django/conf/global_settings.py\n--- a/django/conf/global_settings.py\n+++ b/django/conf/global_settings.py\n@@ -304,7 +304,7 @@ def gettext_noop(s):\n \n # The numeric mode to set newly-uploaded files to. The value should be a mode\n # you'd pass directly to os.chmod; see https://docs.python.org/library/os.html#files-and-directories.\n-FILE_UPLOAD_PERMISSIONS = None\n+FILE_UPLOAD_PERMISSIONS = 0o644\n \n # The numeric mode to assign to newly-created directories, when uploading files.\n # The value should be a mode as you'd pass to os.chmod;\n",
        "pr_link": "https://github.com/django/django/pull/10914"
    }
}