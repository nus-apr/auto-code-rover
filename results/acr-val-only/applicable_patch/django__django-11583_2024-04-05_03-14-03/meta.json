{
    "task_id": "django__django-11583",
    "setup_info": {
        "repo_path": "/home/haifeng/projects/reverse-prompt/SWE-bench/testbed/django__django/setup_django__django__3.0",
        "env_name": "setup_django__django__3.0",
        "pre_install": [],
        "install": "python -m pip install -e .",
        "test_cmd": "./tests/runtests.py --verbosity 2 utils_tests.test_autoreload"
    },
    "task_info": {
        "instance_id": "django__django-11583",
        "base_commit": "60dc957a825232fdda9138e2f8878b2ca407a7c9",
        "hints_text": "Thanks for the report, however as you've admitted there is too many unknowns to accept this ticket. I don't believe that it is related with pathlib, maybe samba connection is unstable it's hard to tell.\nI don't believe that it is related with pathlib Well ... it definitely is, you can see that from the stacktrace. The difference between 2.2 and 2.1 (and every version prior) for the purposes of this report is that AFAIK 2.2 is using pathlib.resolve() which deals with symlinks where under <2.2 I don't think the equivalent (os.path.realpath rather than os.path.abspath) was used. But yes, there's no path forward to fix the ticket as it stands, short of not using pathlib (or at least .resolve()).\nHey Keryn, Have you tried removing resolve() yourself, and did it fix the issue? I chose to use resolve() to try and work around a corner case with symlinks, and to generally just normalize the paths to prevent duplication. Also, regarding your comment above, you would need to use print(repr(path)), as I think the print machinery stops at the first null byte found (hence just /Users, which should never be monitored by itself). If you can provide me some more information I'm more than willing to look into this, or consider removing the resolve() call.\nReplying to Tom Forbes: Hey Keryn, Have you tried removing resolve() yourself, and did it fix the issue? I chose to use resolve() to try and work around a corner case with symlinks, and to generally just normalize the paths to prevent duplication. Also, regarding your comment above, you would need to use print(repr(path)), as I think the print machinery stops at the first null byte found (hence just /Users, which should never be monitored by itself). If you can provide me some more information I'm more than willing to look into this, or consider removing the resolve() call. Hi Tom, I am also getting this error, see here for the stackoverflow question which I have attempted to answer: \u200bhttps://stackoverflow.com/questions/56406965/django-valueerror-embedded-null-byte/56685648#56685648 What is really odd is that it doesn't error every time and looks to error on a random file each time. I believe the issue is caused by having a venv within the top level directory but might be wrong. Bug is on all versions of django >= 2.2.0\nFelix, I'm going to re-open this ticket if that's OK. While this is clearly something \"funky\" going on at a lower level than we handle, it used to work (at least, the error was swallowed). I think this is a fairly simple fix.",
        "created_at": "2019-07-21T20:56:14Z",
        "test_patch": "diff --git a/tests/utils_tests/test_autoreload.py b/tests/utils_tests/test_autoreload.py\n--- a/tests/utils_tests/test_autoreload.py\n+++ b/tests/utils_tests/test_autoreload.py\n@@ -140,6 +140,17 @@ def test_main_module_without_file_is_not_resolved(self):\n         fake_main = types.ModuleType('__main__')\n         self.assertEqual(autoreload.iter_modules_and_files((fake_main,), frozenset()), frozenset())\n \n+    def test_path_with_embedded_null_bytes(self):\n+        for path in (\n+            'embedded_null_byte\\x00.py',\n+            'di\\x00rectory/embedded_null_byte.py',\n+        ):\n+            with self.subTest(path=path):\n+                self.assertEqual(\n+                    autoreload.iter_modules_and_files((), frozenset([path])),\n+                    frozenset(),\n+                )\n+\n \n class TestCommonRoots(SimpleTestCase):\n     def test_common_roots(self):\n",
        "repo": "django/django",
        "problem_statement": "Auto-reloading with StatReloader very intermittently throws \"ValueError: embedded null byte\".\nDescription\n\t\nRaising this mainly so that it's tracked, as I have no idea how to reproduce it, nor why it's happening. It ultimately looks like a problem with Pathlib, which wasn't used prior to 2.2.\nStacktrace:\nTraceback (most recent call last):\n File \"manage.py\" ...\n\texecute_from_command_line(sys.argv)\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/core/management/__init__.py\", line 381, in execute_from_command_line\n\tutility.execute()\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/core/management/__init__.py\", line 375, in execute\n\tself.fetch_command(subcommand).run_from_argv(self.argv)\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/core/management/base.py\", line 323, in run_from_argv\n\tself.execute(*args, **cmd_options)\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/core/management/commands/runserver.py\", line 60, in execute\n\tsuper().execute(*args, **options)\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/core/management/base.py\", line 364, in execute\n\toutput = self.handle(*args, **options)\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/core/management/commands/runserver.py\", line 95, in handle\n\tself.run(**options)\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/core/management/commands/runserver.py\", line 102, in run\n\tautoreload.run_with_reloader(self.inner_run, **options)\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/utils/autoreload.py\", line 577, in run_with_reloader\n\tstart_django(reloader, main_func, *args, **kwargs)\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/utils/autoreload.py\", line 562, in start_django\n\treloader.run(django_main_thread)\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/utils/autoreload.py\", line 280, in run\n\tself.run_loop()\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/utils/autoreload.py\", line 286, in run_loop\n\tnext(ticker)\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/utils/autoreload.py\", line 326, in tick\n\tfor filepath, mtime in self.snapshot_files():\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/utils/autoreload.py\", line 342, in snapshot_files\n\tfor file in self.watched_files():\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/utils/autoreload.py\", line 241, in watched_files\n\tyield from iter_all_python_module_files()\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/utils/autoreload.py\", line 103, in iter_all_python_module_files\n\treturn iter_modules_and_files(modules, frozenset(_error_files))\n File \"/Userz/kez/path/to/venv/lib/python3.6/site-packages/django/utils/autoreload.py\", line 132, in iter_modules_and_files\n\tresults.add(path.resolve().absolute())\n File \"/Users/kez/.pyenv/versions/3.6.2/lib/python3.6/pathlib.py\", line 1120, in resolve\n\ts = self._flavour.resolve(self, strict=strict)\n File \"/Users/kez/.pyenv/versions/3.6.2/lib/python3.6/pathlib.py\", line 346, in resolve\n\treturn _resolve(base, str(path)) or sep\n File \"/Users/kez/.pyenv/versions/3.6.2/lib/python3.6/pathlib.py\", line 330, in _resolve\n\ttarget = accessor.readlink(newpath)\n File \"/Users/kez/.pyenv/versions/3.6.2/lib/python3.6/pathlib.py\", line 441, in readlink\n\treturn os.readlink(path)\nValueError: embedded null byte\nI did print(path) before os.readlink(path) in pathlib and ended up with:\n/Users/kez\n/Users/kez/.pyenv\n/Users/kez/.pyenv/versions\n/Users/kez/.pyenv/versions/3.6.2\n/Users/kez/.pyenv/versions/3.6.2/lib\n/Users/kez/.pyenv/versions/3.6.2/lib/python3.6\n/Users/kez/.pyenv/versions/3.6.2/lib/python3.6/asyncio\n/Users/kez/.pyenv/versions/3.6.2/lib/python3.6/asyncio/selector_events.py\n/Users\nIt always seems to be /Users which is last\nIt may have already printed /Users as part of another .resolve() multiple times (that is, the order is not deterministic, and it may have traversed beyond /Users successfully many times during startup.\nI don't know where to begin looking for the rogue null byte, nor why it only exists sometimes.\nBest guess I have is that there's a mountpoint in /Users to a samba share which may not have been connected to yet? I dunno.\nI have no idea if it's fixable without removing the use of pathlib (which tbh I think should happen anyway, because it's slow) and reverting to using os.path.join and friends. \nI have no idea if it's fixed in a later Python version, but with no easy way to reproduce ... dunno how I'd check.\nI have no idea if it's something specific to my system (pyenv, OSX 10.11, etc)\n",
        "version": "3.0",
        "FAIL_TO_PASS": [
            "test_path_with_embedded_null_bytes (utils_tests.test_autoreload.TestIterModulesAndFiles)",
            "test_paths_are_pathlib_instances (utils_tests.test_autoreload.TestIterModulesAndFiles)"
        ],
        "PASS_TO_PASS": [
            ".pyc and .pyo files are included in the files list.",
            "iter_all_python_module_file() ignores weakref modules.",
            "test_calls_start_django (utils_tests.test_autoreload.RunWithReloaderTests)",
            "test_calls_sys_exit (utils_tests.test_autoreload.RunWithReloaderTests)",
            "test_check_errors (utils_tests.test_autoreload.TestIterModulesAndFiles)",
            "test_check_errors_called (utils_tests.test_autoreload.StartDjangoTests)",
            "test_check_errors_catches_all_exceptions (utils_tests.test_autoreload.TestIterModulesAndFiles)",
            "test_common_roots (utils_tests.test_autoreload.TestCommonRoots)",
            "test_echo_on_called (utils_tests.test_autoreload.StartDjangoTests)",
            "test_file (utils_tests.test_autoreload.StatReloaderTests)",
            "test_file_added (utils_tests.test_autoreload.TestIterModulesAndFiles)",
            "test_glob (utils_tests.test_autoreload.StatReloaderTests)",
            "test_glob_recursive (utils_tests.test_autoreload.StatReloaderTests)",
            "test_main_module_is_resolved (utils_tests.test_autoreload.TestIterModulesAndFiles)",
            "test_main_module_without_file_is_not_resolved (utils_tests.test_autoreload.TestIterModulesAndFiles)",
            "test_manage_py (utils_tests.test_autoreload.RestartWithReloaderTests)",
            "test_module_without_spec (utils_tests.test_autoreload.TestIterModulesAndFiles)",
            "test_multiple_globs (utils_tests.test_autoreload.StatReloaderTests)",
            "test_multiple_recursive_globs (utils_tests.test_autoreload.StatReloaderTests)",
            "test_mutates_error_files (utils_tests.test_autoreload.TestCheckErrors)",
            "test_nested_glob_recursive (utils_tests.test_autoreload.StatReloaderTests)",
            "test_no_exception (utils_tests.test_autoreload.TestRaiseLastException)",
            "test_overlapping_glob_recursive (utils_tests.test_autoreload.StatReloaderTests)",
            "test_overlapping_globs (utils_tests.test_autoreload.StatReloaderTests)",
            "test_python_m_django (utils_tests.test_autoreload.RestartWithReloaderTests)",
            "test_raises_custom_exception (utils_tests.test_autoreload.TestRaiseLastException)",
            "test_raises_exception (utils_tests.test_autoreload.TestRaiseLastException)",
            "test_raises_exception_with_context (utils_tests.test_autoreload.TestRaiseLastException)",
            "test_run_loop_catches_stopiteration (utils_tests.test_autoreload.BaseReloaderTests)",
            "test_run_loop_stop_and_return (utils_tests.test_autoreload.BaseReloaderTests)",
            "test_snapshot_files_ignores_missing_files (utils_tests.test_autoreload.StatReloaderTests)",
            "test_snapshot_files_updates (utils_tests.test_autoreload.StatReloaderTests)",
            "test_snapshot_files_with_duplicates (utils_tests.test_autoreload.StatReloaderTests)",
            "test_starts_thread_with_args (utils_tests.test_autoreload.StartDjangoTests)",
            "test_swallows_keyboard_interrupt (utils_tests.test_autoreload.RunWithReloaderTests)",
            "test_sys_paths_absolute (utils_tests.test_autoreload.TestSysPathDirectories)",
            "test_sys_paths_directories (utils_tests.test_autoreload.TestSysPathDirectories)",
            "test_sys_paths_non_existing (utils_tests.test_autoreload.TestSysPathDirectories)",
            "test_sys_paths_with_directories (utils_tests.test_autoreload.TestSysPathDirectories)",
            "test_tick_does_not_trigger_twice (utils_tests.test_autoreload.StatReloaderTests)",
            "test_wait_for_apps_ready_checks_for_exception (utils_tests.test_autoreload.BaseReloaderTests)",
            "test_wait_for_apps_ready_without_exception (utils_tests.test_autoreload.BaseReloaderTests)",
            "test_watch_files_with_recursive_glob (utils_tests.test_autoreload.BaseReloaderTests)",
            "test_watch_with_glob (utils_tests.test_autoreload.BaseReloaderTests)",
            "test_watch_with_single_file (utils_tests.test_autoreload.BaseReloaderTests)",
            "test_watch_without_absolute (utils_tests.test_autoreload.BaseReloaderTests)",
            "test_watchman_available (utils_tests.test_autoreload.GetReloaderTests)",
            "test_watchman_becomes_unavailable (utils_tests.test_autoreload.StartDjangoTests)",
            "test_watchman_unavailable (utils_tests.test_autoreload.GetReloaderTests)",
            "test_zip_reload (utils_tests.test_autoreload.TestIterModulesAndFiles)"
        ],
        "environment_setup_commit": "419a78300f7cd27611196e1e464d50fd0385ff27",
        "patch": "diff --git a/django/utils/autoreload.py b/django/utils/autoreload.py\n--- a/django/utils/autoreload.py\n+++ b/django/utils/autoreload.py\n@@ -143,6 +143,10 @@ def iter_modules_and_files(modules, extra_files):\n             # The module could have been removed, don't fail loudly if this\n             # is the case.\n             continue\n+        except ValueError as e:\n+            # Network filesystems may return null bytes in file paths.\n+            logger.debug('\"%s\" raised when resolving path: \"%s\"' % (str(e), path))\n+            continue\n         results.add(resolved_path)\n     return frozenset(results)\n \n",
        "pr_link": "https://github.com/django/django/pull/11583"
    }
}