{
    "task_id": "django__django-15320",
    "setup_info": {
        "repo_path": "/home/haifeng/projects/reverse-prompt/SWE-bench/testbed/django__django/setup_django__django__4.1",
        "env_name": "setup_django__django__4.1",
        "pre_install": [],
        "install": "python -m pip install -e .",
        "test_cmd": "./tests/runtests.py --verbosity 2 expressions.tests"
    },
    "task_info": {
        "instance_id": "django__django-15320",
        "base_commit": "b55ebe32417e0884b6b8b3e1bc0379033aa221af",
        "hints_text": "Sounds reasonable.\nSounds reasonable to me as well, I'd only suggest we .clone() the query before altering though.",
        "created_at": "2022-01-14T23:43:34Z",
        "test_patch": "diff --git a/tests/expressions/tests.py b/tests/expressions/tests.py\n--- a/tests/expressions/tests.py\n+++ b/tests/expressions/tests.py\n@@ -537,6 +537,15 @@ def test_subquery_eq(self):\n             qs.query.annotations['small_company'],\n         )\n \n+    def test_subquery_sql(self):\n+        employees = Employee.objects.all()\n+        employees_subquery = Subquery(employees)\n+        self.assertIs(employees_subquery.query.subquery, True)\n+        self.assertIs(employees.query.subquery, False)\n+        compiler = employees_subquery.query.get_compiler(connection=connection)\n+        sql, _ = employees_subquery.as_sql(compiler, connection)\n+        self.assertIn('(SELECT ', sql)\n+\n     def test_in_subquery(self):\n         # This is a contrived test (and you really wouldn't write this query),\n         # but it is a succinct way to test the __in=Subquery() construct.\n",
        "repo": "django/django",
        "problem_statement": "Subquery.as_sql() generates invalid SQL.\nDescription\n\t \n\t\t(last modified by M1ha Shvn)\n\t \nSince \u200bthis commit Subquery.as_sql(...) method returns incorrect SQL removing first and last symbols instead of absent breakets. Adding Subquery().query.subquery = True attribute fixes the problem. From my point of view, it should be set in Subquery constructor.\nfrom django.db import connection\nfrom apps.models import App\nq = Subquery(App.objects.all())\nprint(str(q.query))\n# Output SQL is valid:\n# 'SELECT \"apps_app\".\"id\", \"apps_app\".\"name\" FROM \"apps_app\"'\nprint(q.as_sql(q.query.get_compiler('default'), connection))\n# Outptut SQL is invalid (no S letter at the beggining and \" symbol at the end):\n# ('(ELECT \"apps_app\".\"id\", \"apps_app\".\"name\" FROM \"apps_app)', ())\nq.query.subquery = True\nprint(q.as_sql(q.query.get_compiler('default'), connection))\n# Outputs correct result\n('(SELECT \"apps_app\".\"id\", \"apps_app\".\"name\" FROM \"apps_app\")', ())\n",
        "version": "4.1",
        "FAIL_TO_PASS": [
            "test_subquery_sql (expressions.tests.BasicExpressionsTests)"
        ],
        "PASS_TO_PASS": [
            "Complex expressions of different connection types are possible.",
            "Special characters (e.g. %, _ and \\) stored in database are",
            "The output field for a given Value doesn't get cleaned & validated,",
            "This tests that SQL injection isn't possible using compilation of",
            "We can fill a value in all objects with an other value of the",
            "We can filter for objects, where a value is not equals the value",
            "We can increment a value of all objects in a query set.",
            "test_F_reuse (expressions.tests.ExpressionsTests)",
            "test_aggregate_rawsql_annotation (expressions.tests.BasicExpressionsTests)",
            "test_aggregate_subquery_annotation (expressions.tests.BasicExpressionsTests)",
            "test_aggregates (expressions.tests.ReprTests)",
            "test_and (expressions.tests.CombinableTests)",
            "test_annotate_values_aggregate (expressions.tests.BasicExpressionsTests)",
            "test_annotate_values_count (expressions.tests.BasicExpressionsTests)",
            "test_annotate_values_filter (expressions.tests.BasicExpressionsTests)",
            "test_annotation_with_nested_outerref (expressions.tests.BasicExpressionsTests)",
            "test_annotation_with_outerref (expressions.tests.BasicExpressionsTests)",
            "test_annotations_within_subquery (expressions.tests.BasicExpressionsTests)",
            "test_arithmetic (expressions.tests.BasicExpressionsTests)",
            "test_boolean_expression_combined (expressions.tests.BasicExpressionsTests)",
            "test_boolean_expression_combined_with_empty_Q (expressions.tests.BasicExpressionsTests)",
            "test_boolean_expression_in_Q (expressions.tests.BasicExpressionsTests)",
            "test_case_in_filter_if_boolean_output_field (expressions.tests.BasicExpressionsTests)",
            "test_compile_unresolved (expressions.tests.ValueTests)",
            "test_date_case_subtraction (expressions.tests.FTimeDeltaTests)",
            "test_date_comparison (expressions.tests.FTimeDeltaTests)",
            "test_date_minus_duration (expressions.tests.FTimeDeltaTests)",
            "test_date_subquery_subtraction (expressions.tests.FTimeDeltaTests)",
            "test_date_subtraction (expressions.tests.FTimeDeltaTests)",
            "test_datetime_subquery_subtraction (expressions.tests.FTimeDeltaTests)",
            "test_datetime_subtraction (expressions.tests.FTimeDeltaTests)",
            "test_datetime_subtraction_microseconds (expressions.tests.FTimeDeltaTests)",
            "test_decimal_expression (expressions.tests.ExpressionsNumericTests)",
            "test_deconstruct (expressions.tests.FTests)",
            "test_deconstruct (expressions.tests.ValueTests)",
            "test_deconstruct_output_field (expressions.tests.ValueTests)",
            "test_deepcopy (expressions.tests.FTests)",
            "test_delta_add (expressions.tests.FTimeDeltaTests)",
            "test_delta_subtract (expressions.tests.FTimeDeltaTests)",
            "test_delta_update (expressions.tests.FTimeDeltaTests)",
            "test_distinct_aggregates (expressions.tests.ReprTests)",
            "test_duration_expressions (expressions.tests.FTimeDeltaTests)",
            "test_duration_with_datetime (expressions.tests.FTimeDeltaTests)",
            "test_duration_with_datetime_microseconds (expressions.tests.FTimeDeltaTests)",
            "test_durationfield_add (expressions.tests.FTimeDeltaTests)",
            "test_durationfield_multiply_divide (expressions.tests.FTimeDeltaTests)",
            "test_empty_group_by (expressions.tests.ExpressionWrapperTests)",
            "test_equal (expressions.tests.FTests)",
            "test_equal (expressions.tests.OrderByTests)",
            "test_equal (expressions.tests.SimpleExpressionTests)",
            "test_equal (expressions.tests.ValueTests)",
            "test_equal_output_field (expressions.tests.ValueTests)",
            "test_exclude (expressions.tests.FTimeDeltaTests)",
            "test_exist_single_field_output_field (expressions.tests.BasicExpressionsTests)",
            "test_exists_in_filter (expressions.tests.BasicExpressionsTests)",
            "test_explicit_output_field (expressions.tests.BasicExpressionsTests)",
            "test_expressions (expressions.tests.ReprTests)",
            "test_expressions_in_lookups_join_choice (expressions.tests.IterableLookupInnerExpressionsTests)",
            "test_filter_decimal_expression (expressions.tests.ExpressionsNumericTests)",
            "test_filter_inter_attribute (expressions.tests.BasicExpressionsTests)",
            "test_filter_with_join (expressions.tests.BasicExpressionsTests)",
            "test_filtered_aggregates (expressions.tests.ReprTests)",
            "test_filtering_on_annotate_that_uses_q (expressions.tests.BasicExpressionsTests)",
            "test_filtering_on_q_that_is_boolean (expressions.tests.BasicExpressionsTests)",
            "test_filtering_on_rawsql_that_is_boolean (expressions.tests.BasicExpressionsTests)",
            "test_functions (expressions.tests.ReprTests)",
            "test_hash (expressions.tests.FTests)",
            "test_hash (expressions.tests.OrderByTests)",
            "test_hash (expressions.tests.SimpleExpressionTests)",
            "test_hash (expressions.tests.ValueTests)",
            "test_in_lookup_allows_F_expressions_and_expressions_for_datetimes (expressions.tests.IterableLookupInnerExpressionsTests)",
            "test_in_lookup_allows_F_expressions_and_expressions_for_integers (expressions.tests.IterableLookupInnerExpressionsTests)",
            "test_in_subquery (expressions.tests.BasicExpressionsTests)",
            "test_incorrect_field_in_F_expression (expressions.tests.BasicExpressionsTests)",
            "test_incorrect_joined_field_in_F_expression (expressions.tests.BasicExpressionsTests)",
            "test_invalid_operator (expressions.tests.FTimeDeltaTests)",
            "test_lefthand_addition (expressions.tests.ExpressionOperatorTests)",
            "test_lefthand_bitwise_and (expressions.tests.ExpressionOperatorTests)",
            "test_lefthand_bitwise_left_shift_operator (expressions.tests.ExpressionOperatorTests)",
            "test_lefthand_bitwise_or (expressions.tests.ExpressionOperatorTests)",
            "test_lefthand_bitwise_right_shift_operator (expressions.tests.ExpressionOperatorTests)",
            "test_lefthand_bitwise_xor (expressions.tests.ExpressionOperatorTests)",
            "test_lefthand_bitwise_xor_null (expressions.tests.ExpressionOperatorTests)",
            "test_lefthand_bitwise_xor_right_null (expressions.tests.ExpressionOperatorTests)",
            "test_lefthand_division (expressions.tests.ExpressionOperatorTests)",
            "test_lefthand_modulo (expressions.tests.ExpressionOperatorTests)",
            "test_lefthand_modulo_null (expressions.tests.ExpressionOperatorTests)",
            "test_lefthand_multiplication (expressions.tests.ExpressionOperatorTests)",
            "test_lefthand_power (expressions.tests.ExpressionOperatorTests)",
            "test_lefthand_subtraction (expressions.tests.ExpressionOperatorTests)",
            "test_lefthand_transformed_field_bitwise_or (expressions.tests.ExpressionOperatorTests)",
            "test_mixed_comparisons2 (expressions.tests.FTimeDeltaTests)",
            "test_month_aggregation (expressions.tests.FieldTransformTests)",
            "test_multiple_query_compilation (expressions.tests.FTimeDeltaTests)",
            "test_multiple_transforms_in_values (expressions.tests.FieldTransformTests)",
            "test_negation (expressions.tests.CombinableTests)",
            "test_negative_timedelta_update (expressions.tests.FTimeDeltaTests)",
            "test_nested_outerref_with_function (expressions.tests.BasicExpressionsTests)",
            "test_nested_subquery (expressions.tests.BasicExpressionsTests)",
            "test_nested_subquery_join_outer_ref (expressions.tests.BasicExpressionsTests)",
            "test_nested_subquery_outer_ref_2 (expressions.tests.BasicExpressionsTests)",
            "test_nested_subquery_outer_ref_with_autofield (expressions.tests.BasicExpressionsTests)",
            "test_new_object_create (expressions.tests.BasicExpressionsTests)",
            "test_new_object_save (expressions.tests.BasicExpressionsTests)",
            "test_non_empty_group_by (expressions.tests.ExpressionWrapperTests)",
            "test_not_equal_Value (expressions.tests.FTests)",
            "test_object_create_with_aggregate (expressions.tests.BasicExpressionsTests)",
            "test_object_update (expressions.tests.BasicExpressionsTests)",
            "test_object_update_fk (expressions.tests.BasicExpressionsTests)",
            "test_object_update_unsaved_objects (expressions.tests.BasicExpressionsTests)",
            "test_optimizations (expressions.tests.ExistsTests)",
            "test_or (expressions.tests.CombinableTests)",
            "test_order_by_exists (expressions.tests.BasicExpressionsTests)",
            "test_order_by_multiline_sql (expressions.tests.BasicExpressionsTests)",
            "test_order_of_operations (expressions.tests.BasicExpressionsTests)",
            "test_outerref (expressions.tests.BasicExpressionsTests)",
            "test_outerref_mixed_case_table_name (expressions.tests.BasicExpressionsTests)",
            "test_outerref_with_operator (expressions.tests.BasicExpressionsTests)",
            "test_output_field_decimalfield (expressions.tests.ValueTests)",
            "test_parenthesis_priority (expressions.tests.BasicExpressionsTests)",
            "test_pickle_expression (expressions.tests.BasicExpressionsTests)",
            "test_query_clone (expressions.tests.FTimeDeltaTests)",
            "test_raise_empty_expressionlist (expressions.tests.ValueTests)",
            "test_range_lookup_allows_F_expressions_and_expressions_for_integers (expressions.tests.IterableLookupInnerExpressionsTests)",
            "test_range_lookup_namedtuple (expressions.tests.IterableLookupInnerExpressionsTests)",
            "test_repr (expressions.tests.ValueTests)",
            "test_resolve_output_field (expressions.tests.CombinedExpressionTests)",
            "test_resolve_output_field (expressions.tests.ValueTests)",
            "test_resolve_output_field_failure (expressions.tests.ValueTests)",
            "test_reversed_and (expressions.tests.CombinableTests)",
            "test_reversed_or (expressions.tests.CombinableTests)",
            "test_right_hand_addition (expressions.tests.ExpressionOperatorTests)",
            "test_right_hand_division (expressions.tests.ExpressionOperatorTests)",
            "test_right_hand_modulo (expressions.tests.ExpressionOperatorTests)",
            "test_right_hand_multiplication (expressions.tests.ExpressionOperatorTests)",
            "test_right_hand_subtraction (expressions.tests.ExpressionOperatorTests)",
            "test_righthand_power (expressions.tests.ExpressionOperatorTests)",
            "test_subquery (expressions.tests.BasicExpressionsTests)",
            "test_subquery_eq (expressions.tests.BasicExpressionsTests)",
            "test_subquery_filter_by_aggregate (expressions.tests.BasicExpressionsTests)",
            "test_subquery_filter_by_lazy (expressions.tests.BasicExpressionsTests)",
            "test_subquery_group_by_outerref_in_filter (expressions.tests.BasicExpressionsTests)",
            "test_subquery_in_filter (expressions.tests.BasicExpressionsTests)",
            "test_subquery_references_joined_table_twice (expressions.tests.BasicExpressionsTests)",
            "test_ticket_11722_iexact_lookup (expressions.tests.BasicExpressionsTests)",
            "test_ticket_16731_startswith_lookup (expressions.tests.BasicExpressionsTests)",
            "test_ticket_18375_chained_filters (expressions.tests.BasicExpressionsTests)",
            "test_ticket_18375_join_reuse (expressions.tests.BasicExpressionsTests)",
            "test_ticket_18375_kwarg_ordering (expressions.tests.BasicExpressionsTests)",
            "test_ticket_18375_kwarg_ordering_2 (expressions.tests.BasicExpressionsTests)",
            "test_time_subquery_subtraction (expressions.tests.FTimeDeltaTests)",
            "test_time_subtraction (expressions.tests.FTimeDeltaTests)",
            "test_transform_in_values (expressions.tests.FieldTransformTests)",
            "test_update (expressions.tests.BasicExpressionsTests)",
            "test_update_TimeField_using_Value (expressions.tests.ValueTests)",
            "test_update_UUIDField_using_Value (expressions.tests.ValueTests)",
            "test_update_inherited_field_value (expressions.tests.BasicExpressionsTests)",
            "test_update_with_fk (expressions.tests.BasicExpressionsTests)",
            "test_update_with_none (expressions.tests.BasicExpressionsTests)",
            "test_uuid_pk_subquery (expressions.tests.BasicExpressionsTests)"
        ],
        "environment_setup_commit": "647480166bfe7532e8c471fef0146e3a17e6c0c9",
        "patch": "diff --git a/django/db/models/expressions.py b/django/db/models/expressions.py\n--- a/django/db/models/expressions.py\n+++ b/django/db/models/expressions.py\n@@ -1149,7 +1149,8 @@ class Subquery(BaseExpression, Combinable):\n \n     def __init__(self, queryset, output_field=None, **extra):\n         # Allow the usage of both QuerySet and sql.Query objects.\n-        self.query = getattr(queryset, 'query', queryset)\n+        self.query = getattr(queryset, 'query', queryset).clone()\n+        self.query.subquery = True\n         self.extra = extra\n         super().__init__(output_field)\n \n",
        "pr_link": "https://github.com/django/django/pull/15320"
    }
}