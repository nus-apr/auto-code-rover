{
    "task_id": "scikit-learn__scikit-learn-10949",
    "setup_info": {
        "repo_path": "/home/haifeng/projects/reverse-prompt/SWE-bench/testbed/scikit-learn__scikit-learn/setup_scikit-learn__scikit-learn__0.20",
        "env_name": "setup_scikit-learn__scikit-learn__0.20",
        "pre_install": [],
        "install": "python -m pip install -v --no-use-pep517 --no-build-isolation -e .",
        "test_cmd": "pytest --no-header -rA --tb=no -p no:cacheprovider sklearn/utils/tests/test_validation.py"
    },
    "task_info": {
        "instance_id": "scikit-learn__scikit-learn-10949",
        "base_commit": "3b5abf76597ce6aff76192869f92647c1b5259e7",
        "hints_text": "\n",
        "created_at": "2018-04-10T15:30:56Z",
        "test_patch": "diff --git a/sklearn/utils/tests/test_validation.py b/sklearn/utils/tests/test_validation.py\n--- a/sklearn/utils/tests/test_validation.py\n+++ b/sklearn/utils/tests/test_validation.py\n@@ -7,6 +7,7 @@\n from itertools import product\n \n import pytest\n+from pytest import importorskip\n import numpy as np\n import scipy.sparse as sp\n from scipy import __version__ as scipy_version\n@@ -713,6 +714,38 @@ def test_suppress_validation():\n     assert_raises(ValueError, assert_all_finite, X)\n \n \n+def test_check_dataframe_warns_on_dtype():\n+    # Check that warn_on_dtype also works for DataFrames.\n+    # https://github.com/scikit-learn/scikit-learn/issues/10948\n+    pd = importorskip(\"pandas\")\n+\n+    df = pd.DataFrame([[1, 2, 3], [4, 5, 6]], dtype=object)\n+    assert_warns_message(DataConversionWarning,\n+                         \"Data with input dtype object were all converted to \"\n+                         \"float64.\",\n+                         check_array, df, dtype=np.float64, warn_on_dtype=True)\n+    assert_warns(DataConversionWarning, check_array, df,\n+                 dtype='numeric', warn_on_dtype=True)\n+    assert_no_warnings(check_array, df, dtype='object', warn_on_dtype=True)\n+\n+    # Also check that it raises a warning for mixed dtypes in a DataFrame.\n+    df_mixed = pd.DataFrame([['1', 2, 3], ['4', 5, 6]])\n+    assert_warns(DataConversionWarning, check_array, df_mixed,\n+                 dtype=np.float64, warn_on_dtype=True)\n+    assert_warns(DataConversionWarning, check_array, df_mixed,\n+                 dtype='numeric', warn_on_dtype=True)\n+    assert_warns(DataConversionWarning, check_array, df_mixed,\n+                 dtype=object, warn_on_dtype=True)\n+\n+    # Even with numerical dtypes, a conversion can be made because dtypes are\n+    # uniformized throughout the array.\n+    df_mixed_numeric = pd.DataFrame([[1., 2, 3], [4., 5, 6]])\n+    assert_warns(DataConversionWarning, check_array, df_mixed_numeric,\n+                 dtype='numeric', warn_on_dtype=True)\n+    assert_no_warnings(check_array, df_mixed_numeric.astype(int),\n+                       dtype='numeric', warn_on_dtype=True)\n+\n+\n class DummyMemory(object):\n     def cache(self, func):\n         return func\n",
        "repo": "scikit-learn/scikit-learn",
        "problem_statement": "warn_on_dtype with DataFrame\n#### Description\r\n\r\n``warn_on_dtype`` has no effect when input is a pandas ``DataFrame``\r\n\r\n#### Steps/Code to Reproduce\r\n```python\r\nfrom sklearn.utils.validation import check_array\r\nimport pandas as pd\r\ndf = pd.DataFrame([[1, 2, 3], [2, 3, 4]], dtype=object)\r\nchecked = check_array(df, warn_on_dtype=True)\r\n```\r\n\r\n#### Expected result: \r\n\r\n```python-traceback\r\nDataConversionWarning: Data with input dtype object was converted to float64.\r\n```\r\n\r\n#### Actual Results\r\nNo warning is thrown\r\n\r\n#### Versions\r\nLinux-4.4.0-116-generic-x86_64-with-debian-stretch-sid\r\nPython 3.6.3 |Anaconda, Inc.| (default, Nov  3 2017, 19:19:16) \r\n[GCC 7.2.0]\r\nNumPy 1.13.1\r\nSciPy 0.19.1\r\nScikit-Learn 0.20.dev0\r\nPandas 0.21.0\r\n\nwarn_on_dtype with DataFrame\n#### Description\r\n\r\n``warn_on_dtype`` has no effect when input is a pandas ``DataFrame``\r\n\r\n#### Steps/Code to Reproduce\r\n```python\r\nfrom sklearn.utils.validation import check_array\r\nimport pandas as pd\r\ndf = pd.DataFrame([[1, 2, 3], [2, 3, 4]], dtype=object)\r\nchecked = check_array(df, warn_on_dtype=True)\r\n```\r\n\r\n#### Expected result: \r\n\r\n```python-traceback\r\nDataConversionWarning: Data with input dtype object was converted to float64.\r\n```\r\n\r\n#### Actual Results\r\nNo warning is thrown\r\n\r\n#### Versions\r\nLinux-4.4.0-116-generic-x86_64-with-debian-stretch-sid\r\nPython 3.6.3 |Anaconda, Inc.| (default, Nov  3 2017, 19:19:16) \r\n[GCC 7.2.0]\r\nNumPy 1.13.1\r\nSciPy 0.19.1\r\nScikit-Learn 0.20.dev0\r\nPandas 0.21.0\r\n\n",
        "version": "0.20",
        "FAIL_TO_PASS": [
            "sklearn/utils/tests/test_validation.py::test_check_dataframe_warns_on_dtype"
        ],
        "PASS_TO_PASS": [
            "sklearn/utils/tests/test_validation.py::test_as_float_array",
            "sklearn/utils/tests/test_validation.py::test_as_float_array_nan[X0]",
            "sklearn/utils/tests/test_validation.py::test_as_float_array_nan[X1]",
            "sklearn/utils/tests/test_validation.py::test_check_array",
            "sklearn/utils/tests/test_validation.py::test_check_array_accept_large_sparse_no_exception[bsr]",
            "sklearn/utils/tests/test_validation.py::test_check_array_accept_large_sparse_no_exception[coo]",
            "sklearn/utils/tests/test_validation.py::test_check_array_accept_large_sparse_no_exception[csc]",
            "sklearn/utils/tests/test_validation.py::test_check_array_accept_large_sparse_no_exception[csr]",
            "sklearn/utils/tests/test_validation.py::test_check_array_accept_large_sparse_raise_exception[bsr]",
            "sklearn/utils/tests/test_validation.py::test_check_array_accept_large_sparse_raise_exception[coo]",
            "sklearn/utils/tests/test_validation.py::test_check_array_accept_large_sparse_raise_exception[csc]",
            "sklearn/utils/tests/test_validation.py::test_check_array_accept_large_sparse_raise_exception[csr]",
            "sklearn/utils/tests/test_validation.py::test_check_array_accept_sparse_no_exception",
            "sklearn/utils/tests/test_validation.py::test_check_array_accept_sparse_type_exception",
            "sklearn/utils/tests/test_validation.py::test_check_array_complex_data_error",
            "sklearn/utils/tests/test_validation.py::test_check_array_dtype_stability",
            "sklearn/utils/tests/test_validation.py::test_check_array_dtype_warning",
            "sklearn/utils/tests/test_validation.py::test_check_array_force_all_finite_valid[asarray-inf-False]",
            "sklearn/utils/tests/test_validation.py::test_check_array_force_all_finite_valid[asarray-nan-False]",
            "sklearn/utils/tests/test_validation.py::test_check_array_force_all_finite_valid[asarray-nan-allow-nan]",
            "sklearn/utils/tests/test_validation.py::test_check_array_force_all_finite_valid[csr_matrix-inf-False]",
            "sklearn/utils/tests/test_validation.py::test_check_array_force_all_finite_valid[csr_matrix-nan-False]",
            "sklearn/utils/tests/test_validation.py::test_check_array_force_all_finite_valid[csr_matrix-nan-allow-nan]",
            "sklearn/utils/tests/test_validation.py::test_check_array_large_indices_non_supported_scipy_version[bsr]",
            "sklearn/utils/tests/test_validation.py::test_check_array_large_indices_non_supported_scipy_version[coo]",
            "sklearn/utils/tests/test_validation.py::test_check_array_large_indices_non_supported_scipy_version[csc]",
            "sklearn/utils/tests/test_validation.py::test_check_array_large_indices_non_supported_scipy_version[csr]",
            "sklearn/utils/tests/test_validation.py::test_check_array_memmap[False]",
            "sklearn/utils/tests/test_validation.py::test_check_array_memmap[True]",
            "sklearn/utils/tests/test_validation.py::test_check_array_min_samples_and_features_messages",
            "sklearn/utils/tests/test_validation.py::test_check_array_on_mock_dataframe",
            "sklearn/utils/tests/test_validation.py::test_check_array_pandas_dtype_object_conversion",
            "sklearn/utils/tests/test_validation.py::test_check_consistent_length",
            "sklearn/utils/tests/test_validation.py::test_check_dataframe_fit_attribute",
            "sklearn/utils/tests/test_validation.py::test_check_is_fitted",
            "sklearn/utils/tests/test_validation.py::test_check_memory",
            "sklearn/utils/tests/test_validation.py::test_check_symmetric",
            "sklearn/utils/tests/test_validation.py::test_has_fit_parameter",
            "sklearn/utils/tests/test_validation.py::test_memmap",
            "sklearn/utils/tests/test_validation.py::test_np_matrix",
            "sklearn/utils/tests/test_validation.py::test_ordering",
            "sklearn/utils/tests/test_validation.py::test_suppress_validation"
        ],
        "environment_setup_commit": "55bf5d93e5674f13a1134d93a11fd0cd11aabcd1",
        "patch": "diff --git a/sklearn/utils/validation.py b/sklearn/utils/validation.py\n--- a/sklearn/utils/validation.py\n+++ b/sklearn/utils/validation.py\n@@ -466,6 +466,12 @@ def check_array(array, accept_sparse=False, accept_large_sparse=True,\n         # not a data type (e.g. a column named dtype in a pandas DataFrame)\n         dtype_orig = None\n \n+    # check if the object contains several dtypes (typically a pandas\n+    # DataFrame), and store them. If not, store None.\n+    dtypes_orig = None\n+    if hasattr(array, \"dtypes\") and hasattr(array, \"__array__\"):\n+        dtypes_orig = np.array(array.dtypes)\n+\n     if dtype_numeric:\n         if dtype_orig is not None and dtype_orig.kind == \"O\":\n             # if input is object, convert to float.\n@@ -581,6 +587,16 @@ def check_array(array, accept_sparse=False, accept_large_sparse=True,\n     if copy and np.may_share_memory(array, array_orig):\n         array = np.array(array, dtype=dtype, order=order)\n \n+    if (warn_on_dtype and dtypes_orig is not None and\n+            {array.dtype} != set(dtypes_orig)):\n+        # if there was at the beginning some other types than the final one\n+        # (for instance in a DataFrame that can contain several dtypes) then\n+        # some data must have been converted\n+        msg = (\"Data with input dtype %s were all converted to %s%s.\"\n+               % (', '.join(map(str, sorted(set(dtypes_orig)))), array.dtype,\n+                  context))\n+        warnings.warn(msg, DataConversionWarning, stacklevel=3)\n+\n     return array\n \n \n",
        "pr_link": "https://github.com/scikit-learn/scikit-learn/pull/10949"
    }
}